   1:				; TRACKER Version 1.4
   2:				; to do: mute track, real-time sequencing, MIDI in, more sensible pre-selected instruments, .... 
   3:				
   4:     -	8000          		org $8000
   5:				
   6:     -	0061          	DISPMIDINOTEOFFSET equ $61 ; 0 -> 'a' 
   7:				
   8:     -	00AA          	POSMARKSYM equ	$aa
   9:     -	008F          	SETSYM 	equ	$8f
  10:     -	0058          	CURSYM 	equ	'X'
  11:     -	000D          	ENTER	equ	$0d ; @DSPLY with newline
  12:				
  13:     -	0008          	KCURLEFT	equ 8
  14:     -	0009          	KCURRIGHT	equ 9
  15:     -	005B          	KCURUP		equ 91
  16:     -	000A          	KCURDOWN	equ 10
  17:				
  18:     -	4467          	@DSPLY		equ	$4467
  19:     -	402D          	@EXIT		equ	$402d
  20:     -	002B          	@KBD    	equ 	$002b 
  21:     -	0049          	@KEY    	equ 	$0049 
  22:     -	0033          	@DSP    	equ 	$0033
  23:				
  24:     -	8000  53      	stopped: ascii   'S'
  25:     -	8001  50      	playing: ascii   'P'
  26:     -	8002  46      	free: 	 ascii   'F'
  27:     -	8003  54      	tracked: ascii   'T'
  28:				
  29:				
  30:     -	8004  2A2A2A2A	title:	ascii   '***** MIDI/80 DRUM TRACKER V1.4 -- (C) 2024 BY LAMBDAMIKEL *****'
	              2A204D49
	              44492F38
	              30204452
	              554D2054
	              5241434B
	              45522056
	              312E3420
	              2D2D2028
	              43292032
	              30323420
	              4259204C
	              414D4244
	              414D494B
	              454C202A
	              2A2A2A2A
  31:     -	8044  54524143		ascii   'TRACK: 1 SPEED: -- VOL: 7F NOTE: 24 BARS: 8 STEP: 01 PAT: A S-F '
	              4B3A2031
	              20535045
	              45443A20
	              2D2D2056
	              4F4C3A20
	              3746204E
	              4F54453A
	              20323420
	              42415253
	              3A203820
	              53544550
	              3A203031
	              20504154
	              3A204120
	              532D4620
  32:     -	8084  313D3D3D		ascii	'1===-===+===-===2===-===+===-===3===-===+===-===4===-===+===-===' 
	              2D3D3D3D
	              2B3D3D3D
	              2D3D3D3D
	              323D3D3D
	              2D3D3D3D
	              2B3D3D3D
	              2D3D3D3D
	              333D3D3D
	              2D3D3D3D
	              2B3D3D3D
	              2D3D3D3D
	              343D3D3D
	              2D3D3D3D
	              2B3D3D3D
	              2D3D3D3D
  33:     -	80C4  7C2E2E2E	data:	ascii   '|...-...+...-...|...-...+...-...|...-...+...-...|...-...+...-...'
	              2D2E2E2E
	              2B2E2E2E
	              2D2E2E2E
	              7C2E2E2E
	              2D2E2E2E
	              2B2E2E2E
	              2D2E2E2E
	              7C2E2E2E
	              2D2E2E2E
	              2B2E2E2E
	              2D2E2E2E
	              7C2E2E2E
	              2D2E2E2E
	              2B2E2E2E
	              2D2E2E2E
  34:     -	8104  7C2E2E2E		ascii   '|...-...+...-...|...-...+...-...|...-...+...-...|...-...+...-...'
	              2D2E2E2E
	              2B2E2E2E
	              2D2E2E2E
	              7C2E2E2E
	              2D2E2E2E
	              2B2E2E2E
	              2D2E2E2E
	              7C2E2E2E
	              2D2E2E2E
	              2B2E2E2E
	              2D2E2E2E
	              7C2E2E2E
	              2D2E2E2E
	              2B2E2E2E
	              2D2E2E2E
  35:     -	8144  7C2E2E2E		ascii   '|...-...+...-...|...-...+...-...|...-...+...-...|...-...+...-...'
	              2D2E2E2E
	              2B2E2E2E
	              2D2E2E2E
	              7C2E2E2E
	              2D2E2E2E
	              2B2E2E2E
	              2D2E2E2E
	              7C2E2E2E
	              2D2E2E2E
	              2B2E2E2E
	              2D2E2E2E
	              7C2E2E2E
	              2D2E2E2E
	              2B2E2E2E
	              2D2E2E2E
  36:     -	8184  7C2E2E2E		ascii   '|...-...+...-...|...-...+...-...|...-...+...-...|...-...+...-...'
	              2D2E2E2E
	              2B2E2E2E
	              2D2E2E2E
	              7C2E2E2E
	              2D2E2E2E
	              2B2E2E2E
	              2D2E2E2E
	              7C2E2E2E
	              2D2E2E2E
	              2B2E2E2E
	              2D2E2E2E
	              7C2E2E2E
	              2D2E2E2E
	              2B2E2E2E
	              2D2E2E2E
  37:     -	81C4  7C2E2E2E		ascii   '|...-...+...-...|...-...+...-...|...-...+...-...|...-...+...-...'
	              2D2E2E2E
	              2B2E2E2E
	              2D2E2E2E
	              7C2E2E2E
	              2D2E2E2E
	              2B2E2E2E
	              2D2E2E2E
	              7C2E2E2E
	              2D2E2E2E
	              2B2E2E2E
	              2D2E2E2E
	              7C2E2E2E
	              2D2E2E2E
	              2B2E2E2E
	              2D2E2E2E
  38:     -	8204  7C2E2E2E		ascii   '|...-...+...-...|...-...+...-...|...-...+...-...|...-...+...-...'
	              2D2E2E2E
	              2B2E2E2E
	              2D2E2E2E
	              7C2E2E2E
	              2D2E2E2E
	              2B2E2E2E
	              2D2E2E2E
	              7C2E2E2E
	              2D2E2E2E
	              2B2E2E2E
	              2D2E2E2E
	              7C2E2E2E
	              2D2E2E2E
	              2B2E2E2E
	              2D2E2E2E
  39:     -	8244  353D3D3D		ascii	'5===-===+===-===6===-===+===-===7===-===+===-===8===-===+===-===' 
	              2D3D3D3D
	              2B3D3D3D
	              2D3D3D3D
	              363D3D3D
	              2D3D3D3D
	              2B3D3D3D
	              2D3D3D3D
	              373D3D3D
	              2D3D3D3D
	              2B3D3D3D
	              2D3D3D3D
	              383D3D3D
	              2D3D3D3D
	              2B3D3D3D
	              2D3D3D3D
  40:     -	8284  7C2E2E2E		ascii   '|...-...+...-...|...-...+...-...|...-...+...-...|...-...+...-...'
	              2D2E2E2E
	              2B2E2E2E
	              2D2E2E2E
	              7C2E2E2E
	              2D2E2E2E
	              2B2E2E2E
	              2D2E2E2E
	              7C2E2E2E
	              2D2E2E2E
	              2B2E2E2E
	              2D2E2E2E
	              7C2E2E2E
	              2D2E2E2E
	              2B2E2E2E
	              2D2E2E2E
  41:     -	82C4  7C2E2E2E		ascii   '|...-...+...-...|...-...+...-...|...-...+...-...|...-...+...-...'
	              2D2E2E2E
	              2B2E2E2E
	              2D2E2E2E
	              7C2E2E2E
	              2D2E2E2E
	              2B2E2E2E
	              2D2E2E2E
	              7C2E2E2E
	              2D2E2E2E
	              2B2E2E2E
	              2D2E2E2E
	              7C2E2E2E
	              2D2E2E2E
	              2B2E2E2E
	              2D2E2E2E
  42:     -	8304  7C2E2E2E		ascii   '|...-...+...-...|...-...+...-...|...-...+...-...|...-...+...-...'
	              2D2E2E2E
	              2B2E2E2E
	              2D2E2E2E
	              7C2E2E2E
	              2D2E2E2E
	              2B2E2E2E
	              2D2E2E2E
	              7C2E2E2E
	              2D2E2E2E
	              2B2E2E2E
	              2D2E2E2E
	              7C2E2E2E
	              2D2E2E2E
	              2B2E2E2E
	              2D2E2E2E
  43:     -	8344  7C2E2E2E		ascii   '|...-...+...-...|...-...+...-...|...-...+...-...|...-...+...-...'
	              2D2E2E2E
	              2B2E2E2E
	              2D2E2E2E
	              7C2E2E2E
	              2D2E2E2E
	              2B2E2E2E
	              2D2E2E2E
	              7C2E2E2E
	              2D2E2E2E
	              2B2E2E2E
	              2D2E2E2E
	              7C2E2E2E
	              2D2E2E2E
	              2B2E2E2E
	              2D2E2E2E
  44:     -	8384  7C2E2E2E		ascii   '|...-...+...-...|...-...+...-...|...-...+...-...|...-...+...-...'
	              2D2E2E2E
	              2B2E2E2E
	              2D2E2E2E
	              7C2E2E2E
	              2D2E2E2E
	              2B2E2E2E
	              2D2E2E2E
	              7C2E2E2E
	              2D2E2E2E
	              2B2E2E2E
	              2D2E2E2E
	              7C2E2E2E
	              2D2E2E2E
	              2B2E2E2E
	              2D2E2E2E
  45:     -	83C4  7C2E2E2E		ascii   '|...-...+...-...|...-...+...-...|...-...+...-...|...-...+...-...'
	              2D2E2E2E
	              2B2E2E2E
	              2D2E2E2E
	              7C2E2E2E
	              2D2E2E2E
	              2B2E2E2E
	              2D2E2E2E
	              7C2E2E2E
	              2D2E2E2E
	              2B2E2E2E
	              2D2E2E2E
	              7C2E2E2E
	              2D2E2E2E
	              2B2E2E2E
	              2D2E2E2E
  46:				
  47:     -	8404  2A2A2A2A	helpt:	ascii   '************************** HELP PAGE ***************************'
	              2A2A2A2A
	              2A2A2A2A
	              2A2A2A2A
	              2A2A2A2A
	              2A2A2A2A
	              2A2A2048
	              454C5020
	              50414745
	              202A2A2A
	              2A2A2A2A
	              2A2A2A2A
	              2A2A2A2A
	              2A2A2A2A
	              2A2A2A2A
	              2A2A2A2A
  48:     -	8444  43555253		ascii   'CURSOR MOVEMENT       : A D W X                                 '
	              4F52204D
	              4F56454D
	              454E5420
	              20202020
	              20203A20
	              41204420
	              57205820
	              20202020
	              20202020
	              20202020
	              20202020
	              20202020
	              20202020
	              20202020
	              20202020
  49:     -	8484  58204355		ascii   'X CURSOR MOVEMENT FINE: Z C                                     '
	              52534F52
	              204D4F56
	              454D454E
	              54204649
	              4E453A20
	              5A204320
	              20202020
	              20202020
	              20202020
	              20202020
	              20202020
	              20202020
	              20202020
	              20202020
	              20202020
  50:     -	84C4  4A554D50		ascii   'JUMP TO BAR POS       : 1 2 3 4 5 6 7 8                         '
	              20544F20
	              42415220
	              504F5320
	              20202020
	              20203A20
	              31203220
	              33203420
	              35203620
	              37203820
	              20202020
	              20202020
	              20202020
	              20202020
	              20202020
	              20202020
  51:     -	8504  4348414E		ascii   'CHANGE BAR COUNT      : B                                       '
	              47452042
	              41522043
	              4F554E54
	              20202020
	              20203A20
	              42202020
	              20202020
	              20202020
	              20202020
	              20202020
	              20202020
	              20202020
	              20202020
	              20202020
	              20202020
  52:     -	8544  4E455854		ascii   'NEXT / PREV GRID POS  : ARROW-UP ARROW-DOWN                     '
	              202F2050
	              52455620
	              47524944
	              20504F53
	              20203A20
	              4152524F
	              572D5550
	              20415252
	              4F572D44
	              4F574E20
	              20202020
	              20202020
	              20202020
	              20202020
	              20202020
  53:     -	8584  434C4541		ascii   'CLEAR GRID POS        : CLEAR                                   '
	              52204752
	              49442050
	              4F532020
	              20202020
	              20203A20
	              434C4541
	              52202020
	              20202020
	              20202020
	              20202020
	              20202020
	              20202020
	              20202020
	              20202020
	              20202020
  54:     -	85C4  53455420		ascii   'SET   GRID POS        : SPACE                                   '
	              20204752
	              49442050
	              4F532020
	              20202020
	              20203A20
	              53504143
	              45202020
	              20202020
	              20202020
	              20202020
	              20202020
	              20202020
	              20202020
	              20202020
	              20202020
  55:     -	8604  53455420		ascii   'SET   GRID POS & SOUND: ENTER                                   '
	              20204752
	              49442050
	              4F532026
	              20534F55
	              4E443A20
	              454E5445
	              52202020
	              20202020
	              20202020
	              20202020
	              20202020
	              20202020
	              20202020
	              20202020
	              20202020
  56:     -	8644  504C4159		ascii   'PLAY & STOP           : P                                       '
	              20262053
	              544F5020
	              20202020
	              20202020
	              20203A20
	              50202020
	              20202020
	              20202020
	              20202020
	              20202020
	              20202020
	              20202020
	              20202020
	              20202020
	              20202020
  57:     -	8684  544F4747		ascii   'TOGGLE TRACKING       : T                                       '
	              4C452054
	              5241434B
	              494E4720
	              20202020
	              20203A20
	              54202020
	              20202020
	              20202020
	              20202020
	              20202020
	              20202020
	              20202020
	              20202020
	              20202020
	              20202020
  58:     -	86C4  4348414E		ascii   'CHANGE PLAYBACK SPEED : N M , .                                 '
	              47452050
	              4C415942
	              41434B20
	              53504545
	              44203A20
	              4E204D20
	              2C202E20
	              20202020
	              20202020
	              20202020
	              20202020
	              20202020
	              20202020
	              20202020
	              20202020
  59:     -	8704  4348414E		ascii   'CHANGE CUR TRACK DRUM : ARROW-LEFT ARROW-RIGHT                  '
	              47452043
	              55522054
	              5241434B
	              20445255
	              4D203A20
	              4152524F
	              572D4C45
	              46542041
	              52524F57
	              2D524947
	              48542020
	              20202020
	              20202020
	              20202020
	              20202020
  60:     -	8744  4348414E		ascii   'CHANGE GRID STEP      : G                                       '
	              47452047
	              52494420
	              53544550
	              20202020
	              20203A20
	              47202020
	              20202020
	              20202020
	              20202020
	              20202020
	              20202020
	              20202020
	              20202020
	              20202020
	              20202020
  61:     -	8784  4C4F4144		ascii   'LOAD & SAVE           : L S                                     '
	              20262053
	              41564520
	              20202020
	              20202020
	              20203A20
	              4C205320
	              20202020
	              20202020
	              20202020
	              20202020
	              20202020
	              20202020
	              20202020
	              20202020
	              20202020
  62:     -	87C4  48454C50		ascii   'HELP                  : H                                       '
	              20202020
	              20202020
	              20202020
	              20202020
	              20203A20
	              48202020
	              20202020
	              20202020
	              20202020
	              20202020
	              20202020
	              20202020
	              20202020
	              20202020
	              20202020
  63:     -	8804  51554954		ascii   'QUIT                  : Q                                       '	
	              20202020
	              20202020
	              20202020
	              20202020
	              20203A20
	              51202020
	              20202020
	              20202020
	              20202020
	              20202020
	              20202020
	              20202020
	              20202020
	              20202020
	              20202020
  64:				
  65:				
  66:     -	8844  2E      	lastcur	     byte	'.'
  67:     -	8845  C03C    	lastcurpos   word 	$3c00+3*64 
  68:				
  69:     -	8847  00      	cursorx	byte 	0
  70:     -	8848  03      	cursory	byte 	3
  71:     -	8849  00      	blink   byte    0
  72:     -	884A  00      	status  byte    0
  73:     -	884B  00      	track	byte    0
  74:     -	884C  00      	delayc 	byte	0
  75:     -	884D  0A      	tempo   byte	10
  76:     -	884E  08      	numbars byte	8
  77:     -	884F  80      	numticks byte	8*16 
  78:     -	8850  04      	gridres byte  	4
  79:				
  80:     -	8851  00      	midicount byte  0
  81:     -	8852  00      	curnote   byte  0
  82:     -	8853  00      	curvel    byte  0	
  83:					
  84:     -	8854  FC      	quantpat  byte  11111100b
  85:     -	8855          	tracks1 defs    6*64 		
  86:     -	89D5          	tracks2 defs    6*64
  87:				
  88:     -	8B55  24262833	instracks byte 36, 38, 40, 51, 44, 46 
	              2C2E
  89:				
  90:     -	8B5B  00      	memcursorx byte 	0
  91:     -	8B5C  00      	memcursory byte 	0
  92:					
  93:     -	8B5D  00      	trackpos    byte        0
  94:     -	8B5E  00      	qtrackpos   byte 	0
  95:				
  96:				
  97:				
  98:				keydown macro key
  99:					ld	a,(key >> 8)
 100:					and	key % $100
 101:					endm 
 102:				
 103:     -	0101          	k_@	equ	$380101
 104:     -	0102          	k_A	equ	$380102
 105:     -	0104          	k_B	equ	$380104
 106:     -	0108          	k_C	equ	$380108
 107:     -	0110          	k_D	equ	$380110
 108:     -	0120          	k_E	equ	$380120
 109:     -	0140          	k_F	equ	$380140
 110:     -	0180          	k_G	equ	$380180
 111:				
 112:     -	0201          	k_H	equ	$380201
 113:     -	0202          	k_I	equ	$380202
 114:     -	0204          	k_J	equ	$380204
 115:     -	0208          	k_K	equ	$380208
 116:     -	0210          	k_L	equ	$380210
 117:     -	0220          	k_M	equ	$380220
 118:     -	0240          	k_N	equ	$380240
 119:     -	0280          	k_O	equ	$380280
 120:				
 121:     -	0401          	k_P	equ	$380401
 122:     -	0402          	k_Q	equ	$380402
 123:     -	0404          	k_R	equ	$380404
 124:     -	0408          	k_S	equ	$380408
 125:     -	0410          	k_T	equ	$380410
 126:     -	0420          	k_U	equ	$380420
 127:     -	0440          	k_V	equ	$380440
 128:     -	0480          	k_W	equ	$380480
 129:				
 130:     -	0801          	k_X	equ	$380801
 131:     -	0802          	k_Y	equ	$380802
 132:     -	0804          	k_Z	equ	$380804
 133:				
 134:     -	1001          	k_0	equ	$381001
 135:     -	1002          	k_1	equ	$381002
 136:     -	1004          	k_2	equ	$381004
 137:     -	1008          	k_3	equ	$381008
 138:     -	1010          	k_4	equ	$381010
 139:     -	1020          	k_5	equ	$381020
 140:     -	1040          	k_6	equ	$381040
 141:     -	1080          	k_7	equ	$381080
 142:				
 143:     -	2001          	k_8	equ	$382001
 144:     -	2002          	k_9	equ	$382002
 145:     -	2004          	k_colon	equ	$382004
 146:     -	2008          	k_semi	equ	$382008
 147:     -	2010          	k_comma	equ	$382010
 148:     -	2020          	k_dash	equ	$382020
 149:     -	2040          	k_dot	equ	$382040
 150:     -	2080          	k_slash	equ	$382080
 151:				
 152:     -	4001          	k_enter	equ	$384001
 153:     -	4002          	k_clear	equ	$384002
 154:     -	4004          	k_break	equ	$384004
 155:     -	4008          	k_up	equ	$384008
 156:     -	4010          	k_down	equ	$384010
 157:     -	4020          	k_left	equ	$384020
 158:     -	4040          	k_right	equ	$384040
 159:     -	4080          	k_space	equ	$384080
 160:				
 161:     -	8001          	k_shift	equ	$388001
 162:				
 163:				
 164:     -	8B5F          	main:
 165:				
 166:    0+11	8B5F  DBFF    		in  a,($ff)
 167:   11+7	8B61  F610    		or  a,$10 		; enable IO on Model III 
 168:					; and a,~$20 		; disable video wait states M III 
 169:   18+7	8B63  E6BF    		and a,~$40 		; slode mode M4 
 170:   25+11	8B65  D3EC    		out ($ec),a
 171:				
 172:   36+10	8B67  21C480  		ld	hl,data 
 173:   46+10	8B6A  115588  		ld	de,tracks1
 174:   56+10	8B6D  018001  		ld	bc,6*64 
 175:   66+16+5	8B70  EDB0    		ldir
 176:				
 177:   82+10	8B72  21C480  		ld	hl,data 
 178:   92+10	8B75  11D589  		ld	de,tracks2 
 179:  102+10	8B78  018001  		ld	bc,6*64 
 180:  112+16+5	8B7B  EDB0    		ldir
 181:				
 182:     -	8B7D          	main2:
 183:				
 184:  128+10	8B7D  21003C  		ld	hl,$3c00
 185:  138+10	8B80  11013C  		ld	de,$3c00+1
 186:  148+10	8B83  01FF03  		ld	bc,1024-1
 187:  158+10	8B86  3620    		ld	(hl),' '
 188:  168+16+5	8B88  EDB0    		ldir
 189:				
 190:  184+10	8B8A  210480  		ld	hl,title
 191:  194+10	8B8D  11003C  		ld	de,$3c00
 192:  204+10	8B90  010004  		ld	bc,1024
 193:  214+16+5	8B93  EDB0    		ldir
 194:				
 195:				
 196:  230+17	8B95  CD1992  		call screenupdate
 197:  247+17	8B98  CD3092  		call showcursor
 198:  264+17	8B9B  CDEB91  		call showplaycursor
 199:  281+17	8B9E  CD6D92  		call showtempo
 200:				
 201:     -	8BA1          	loop:
 202:  298+13	8BA1  3A4A88  		ld a, (status) ; stopped ? 
 203:  311+4	8BA4  B7      		or a
 204:  315+10	8BA5  CA188C  		jp z, nostep
 205:					
 206:  325+13	8BA8  3A4C88  		ld a, (delayc)
 207:  338+4	8BAB  3C      		inc a
 208:  342+10	8BAC  214C88  		ld hl,delayc
 209:  352+7	8BAF  77      		ld (hl), a
 210:  359+4	8BB0  47      		ld b, a
 211:  363+13	8BB1  3A4D88  		ld a, (tempo) 
 212:  376+4	8BB4  B8      		cp b
 213:  380+10	8BB5  C2188C  		jp nz, nostep
 214:					
 215:					;;  inc note pointer
 216:  390+17	8BB8  CDA091  		call nextnote
 217:  407+17	8BBB  CDEB91  		call showplaycursor
 218:  424+17	8BBE  CDB592  		call playnotes
 219:				
 220:  441+7	8BC1  3E00    		ld a,0
 221:  448+13	8BC3  324C88  		ld (delayc),a
 222:				
 223:  461+13	8BC6  3A4B88  		ld a,(track)
 224:  474+4	8BC9  B7      		or a
 225:  478+10	8BCA  CA188C  		jp z, nostep
 226:				
 227:					;; tracked - set screen cursor x to playcursor x
 228:				
 229:  488+13	8BCD  3A5D8B  		ld a,(trackpos)
 230:  501+8	8BD0  CB77    		bit 6,a
 231:  509+7+5	8BD2  201E    		jr nz,trackcury ; > 64 inc y
 232:				
 233:  516+8	8BD4  CBB7    		res 6,a
 234:  524+13	8BD6  324788  		ld (cursorx),a
 235:  537+13	8BD9  325B8B  		ld (memcursorx),a
 236:					
 237:  550+13	8BDC  3A4888  		ld a,(cursory)
 238:  563+7	8BDF  FE0A    		cp 10
 239:  570+7+5	8BE1  382B    		jr c, showtrackcur
 240:				
 241:					
 242:  577+7	8BE3  D607    		sub 7
 243:  584+13	8BE5  324888  		ld (cursory), a
 244:  597+13	8BE8  3A5C8B  		ld a,(memcursory)
 245:  610+7	8BEB  D606    		sub 6
 246:  617+13	8BED  325C8B  		ld (memcursory),a
 247:					
 248:  630+12	8BF0  181C    		jr showtrackcur	
 249:				
 250:     -	8BF2          	trackcury:
 251:  642+8	8BF2  CBB7    		res 6,a	
 252:					
 253:  650+13	8BF4  324788  		ld (cursorx),a
 254:  663+13	8BF7  325B8B  		ld (memcursorx),a
 255:				
 256:  676+13	8BFA  3A4888  		ld a,(cursory)
 257:  689+7	8BFD  FE0A    		cp 10
 258:  696+7+5	8BFF  300D    		jr nc,showtrackcur
 259:					
 260:  703+7	8C01  C607    		add 7	
 261:  710+13	8C03  324888  		ld (cursory),a
 262:  723+13	8C06  3A5C8B  		ld a,(memcursory)
 263:  736+7	8C09  C606    		add 6 
 264:  743+13	8C0B  325C8B  		ld (memcursory),a
 265:					
 266:				
 267:     -	8C0E          	showtrackcur:
 268:  756+10	8C0E  214988  		ld hl, blink
 269:  766+10	8C11  367F    		ld (hl), 127
 270:				
 271:  776+17	8C13  CD3092  		call showcursor
 272:				
 273:  793+12	8C16  1816    		jr scan 
 274:					
 275:     -	8C18          	nostep:
 276:				
 277:  805+13	8C18  3A4988  		ld a,(blink)
 278:  818+4	8C1B  3C      		inc a
 279:  822+13	8C1C  324988  		ld (blink), a
 280:				
 281:  835+4	8C1F  B7      		or a
 282:  839+10	8C20  C2268C  		jp nz, cur1
 283:  849+17	8C23  CD3092  		call showcursor
 284:				
 285:     -	8C26          	cur1:	 
 286:  866+7	8C26  FE7F    		cp 127
 287:  873+10	8C28  C22E8C  		jp nz, scan  
 288:  883+17	8C2B  CD3092  		call showcursor
 289:						
 290:     -	8C2E          	scan:
 291:					
 292:  900+13	8C2E  3A4A88  		ld a, (status) 
 293:  913+4	8C31  B7      		or a
 294:  917+7+5	8C32  2021    		jr nz,scancont
 295:				
 296:					;; here we only sample if the tracking is stopped!
 297:				
 298:  924+17	8C34  CD848D  		call midiin
 299:  941+4	8C37  B7      		or a
 300:  945+7+5	8C38  2803    		jr z, keyscan
 301:				
 302:					;; else, we got a note in the buffer: just treat this as setgridandsound for now
 303:  952+10	8C3A  C39A8F  		jp setgridandsound
 304:				
 305:     -	8C3D          	keyscan:	 
 306:				
 307:  962+17	8C3D  CD2B00  		call @KBD
 308:  979+4	8C40  B7      		or a
 309:  983+10	8C41  CAA18B  		jp z,loop
 310:				
 311:  993+7	8C44  FE20    	        cp ' ' ; space
 312: 1000+10	8C46  CA4690  		jp z,setgridkey 
 313:				
 314: 1010+7	8C49  FE0D    		cp 13 ; enter
 315: 1017+10	8C4B  CABF8F  		jp z,setgridandsoundkey
 316:				
 317: 1027+7	8C4E  FE1F    		cp 31 ; clear 
 318: 1034+10	8C50  CA7E90  		jp z,erasegrid
 319:				
 320: 1044+12	8C53  1810    		jr scancont1
 321:				
 322:     -	8C55          	scancont:
 323:				
 324: 1056+17	8C55  CD848D  		call midiin
 325: 1073+4	8C58  B7      		or a
 326: 1077+7+5	8C59  2803    		jr z, keyscan1 
 327:				
 328:					;; else, we got a note in the buffer: just treat this as setgridandsound for now
 329: 1084+10	8C5B  C39A8F  		jp setgridandsound
 330:				
 331:     -	8C5E          	keyscan1:	 
 332:				
 333: 1094+17	8C5E  CD2B00  		call @KBD
 334: 1111+4	8C61  B7      		or a
 335: 1115+10	8C62  CAA18B  		jp z,loop
 336:				
 337:     -	8C65          	scancont1:
 338:				
 339: 1125+7	8C65  FE5A    		cp 'Z' 
 340: 1132+10	8C67  CAFC90  		jp z,left
 341: 1142+7	8C6A  FE59    		cp 'Y' 
 342: 1149+10	8C6C  CAFC90  		jp z,left
 343: 1159+7	8C6F  FE41    		cp 'A' 
 344: 1166+10	8C71  CAFF8D  		jp z,prevbar
 345: 1176+7	8C74  FE43    		cp 'C'
 346: 1183+10	8C76  CA0E91  		jp z,right
 347: 1193+7	8C79  FE44    		cp 'D'
 348: 1200+10	8C7B  CAE88D  		jp z,nextbar
 349: 1210+7	8C7E  FE57    		cp 'W'
 350: 1217+10	8C80  CA2191  		jp z,up
 351: 1227+7	8C83  FE58    		cp 'X' 
 352: 1234+10	8C85  CA3E91  		jp z,down
 353:				
 354: 1244+7	8C88  FE2C    		cp ',' 
 355: 1251+10	8C8A  CA1C8F  		jp z,faster	
 356: 1261+7	8C8D  FE2E    		cp '.'
 357: 1268+10	8C8F  CA518F  		jp z,slower 
 358: 1278+7	8C92  FE4E    		cp 'N' 
 359: 1285+10	8C94  CA368F  		jp z,faster1
 360: 1295+7	8C97  FE4D    		cp 'M' 
 361: 1302+10	8C99  CA6B8F  		jp z,slower1 
 362:						
 363: 1312+7	8C9C  FE50    		cp 'P' 
 364: 1319+10	8C9E  CAAE90  		jp z,startstop
 365:				
 366: 1329+7	8CA1  FE54    		cp 'T'
 367: 1336+10	8CA3  CAD590  		jp z,trackstatus
 368:					
 369: 1346+7	8CA6  FE08    		cp KCURLEFT
 370: 1353+10	8CA8  CA908F  		jp z,instrdown
 371:				
 372: 1363+7	8CAB  FE09    		cp KCURRIGHT
 373: 1370+10	8CAD  CA868F  		jp z,instrup 
 374:				
 375: 1380+7	8CB0  FE5B    		cp KCURUP 
 376: 1387+10	8CB2  CAE88D  		jp z,nextbar
 377:				
 378: 1397+7	8CB5  FE0A    		cp KCURDOWN 
 379: 1404+10	8CB7  CAFF8D  		jp z,prevbar
 380:				
 381: 1414+7	8CBA  FE31    		cp '1'
 382: 1421+10	8CBC  CA148E  		jp z,bar1
 383:				
 384: 1431+7	8CBF  FE32    		cp '2'
 385: 1438+10	8CC1  CA358E  		jp z,bar2
 386:				
 387: 1448+7	8CC4  FE33    		cp '3'
 388: 1455+10	8CC6  CA568E  		jp z,bar3
 389:				
 390: 1465+7	8CC9  FE34    		cp '4'
 391: 1472+10	8CCB  CA778E  		jp z,bar4
 392:				
 393: 1482+7	8CCE  FE35    		cp '5'
 394: 1489+10	8CD0  CA988E  		jp z,bar5
 395:				
 396: 1499+7	8CD3  FE36    		cp '6'
 397: 1506+10	8CD5  CAB98E  		jp z,bar6
 398:				
 399: 1516+7	8CD8  FE37    		cp '7'
 400: 1523+10	8CDA  CADA8E  		jp z,bar7
 401:				
 402: 1533+7	8CDD  FE38    		cp '8'
 403: 1540+10	8CDF  CAFB8E  		jp z,bar8
 404:				
 405: 1550+7	8CE2  FE51    		cp 'Q'
 406: 1557+10	8CE4  CAE58D  		jp z,quit
 407:				
 408: 1567+7	8CE7  FE48    		cp 'H'
 409: 1574+10	8CE9  CAC18D  		jp z,help
 410:				
 411: 1584+7	8CEC  FE4C    		cp 'L'
 412: 1591+10	8CEE  CADF8D  		jp z,load
 413:				
 414: 1601+7	8CF1  FE53    		cp 'S'
 415: 1608+10	8CF3  CAE28D  		jp z,save
 416:				
 417: 1618+7	8CF6  FE47    		cp 'G'
 418: 1625+10	8CF8  CA158D  		jp z,chgridres
 419:				
 420: 1635+7	8CFB  FE42    		cp 'B'
 421: 1642+10	8CFD  CA6C8D  		jp z,chgnumbars 
 422:				
 423: 1652+10	8D00  C3A18B  		jp loop 
 424:					
 425:					;;  do a screen update after keypress and continue 
 426:     -	8D03          	cont:
 427: 1662+17	8D03  CD1992  		call screenupdate
 428: 1679+17	8D06  CDA992  		call showtrack
 429: 1696+17	8D09  CD9B92  		call showtrackdrum
 430: 1713+17	8D0C  CD3393  		call showgridres
 431: 1730+17	8D0F  CD4193  		call showbars
 432:					
 433: 1747+10	8D12  C3A18B  		jp loop
 434:				
 435:     -	8D15          	chgridres:
 436: 1757+13	8D15  3A5088  		ld a,(gridres)
 437: 1770+8	8D18  CB27    		sla a 
 438: 1778+7	8D1A  E61F    		and $1f
 439: 1785+7+5	8D1C  2002    		jr nz,chgridres1
 440: 1792+7	8D1E  3E01    		ld a,1
 441:					
 442:     -	8D20          	chgridres1: 
 443: 1799+13	8D20  325088  		ld (gridres),a
 444:					
 445: 1812+7	8D23  FE01    		cp a,1
 446: 1819+7+5	8D25  2008    		jr nz, gridres2
 447: 1826+7	8D27  3EFF    		ld a,11111111b
 448: 1833+13	8D29  325488  		ld (quantpat), a	
 449: 1846+10	8D2C  C3038D  		jp cont
 450:					
 451:     -	8D2F          	gridres2:
 452: 1856+7	8D2F  FE02    		cp a,2
 453: 1863+7+5	8D31  2008    		jr nz, gridres4
 454: 1870+7	8D33  3EFE    		ld a,11111110b
 455: 1877+13	8D35  325488  		ld (quantpat), a	
 456: 1890+10	8D38  C3038D  		jp cont
 457:				
 458:     -	8D3B          	gridres4:
 459: 1900+7	8D3B  FE04    		cp a,4
 460: 1907+7+5	8D3D  2008    		jr nz, gridres8
 461: 1914+7	8D3F  3EFC    		ld a,11111100b
 462: 1921+13	8D41  325488  		ld (quantpat), a	
 463: 1934+10	8D44  C3038D  		jp cont
 464:				
 465:     -	8D47          	gridres8:
 466: 1944+7	8D47  FE08    		cp a,8
 467: 1951+7+5	8D49  2008    		jr nz, gridres16
 468: 1958+7	8D4B  3EF8    		ld a,11111000b
 469: 1965+13	8D4D  325488  		ld (quantpat), a	
 470: 1978+10	8D50  C3038D  		jp cont
 471:				
 472:     -	8D53          	gridres16:
 473: 1988+7	8D53  FE10    		cp a,16
 474: 1995+7+5	8D55  2008    		jr nz, gridres32
 475: 2002+7	8D57  3EF0    		ld a,11110000b
 476: 2009+13	8D59  325488  		ld (quantpat), a	
 477: 2022+10	8D5C  C3038D  		jp cont
 478:				
 479:     -	8D5F          	gridres32:
 480: 2032+7	8D5F  FE20    		cp a,32
 481: 2039+10	8D61  C2038D  		jp nz, cont 
 482: 2049+7	8D64  3EE0    		ld a,11100000b
 483: 2056+13	8D66  325488  		ld (quantpat), a	
 484: 2069+10	8D69  C3038D  		jp cont
 485:				
 486:				
 487:     -	8D6C          	chgnumbars:
 488: 2079+13	8D6C  3A4E88  		ld a,(numbars)
 489: 2092+4	8D6F  3D      		dec a 
 490: 2096+4	8D70  3C      		inc a
 491: 2100+7	8D71  E607    		and $07
 492: 2107+4	8D73  3C      		inc a	
 493: 2111+13	8D74  324E88  		ld (numbars),a
 494:				
 495: 2124+4	8D77  47      		ld b,a
 496: 2128+7	8D78  3E00    		ld a,0
 497:     -	8D7A          	countticks:	
 498: 2135+7	8D7A  C610    		add 16 
 499: 2142+8+5	8D7C  10FC    		djnz countticks
 500:				
 501: 2150+13	8D7E  324F88  		ld (numticks),a
 502: 2163+10	8D81  C3038D  		jp cont
 503:				
 504:     -	8D84          	midiin:
 505:				
 506: 2173+11	8D84  DB09    		in a,(9)
 507: 2184+4	8D86  B7      		or a
 508: 2188+5+6	8D87  C8      		ret z
 509:				
 510:					;;  byte available
 511:				
 512: 2193+11	8D88  DB08    		in a,(8)
 513: 2204+8	8D8A  CB7F    		bit 7,a
 514: 2212+7+5	8D8C  201D    		jr nz, midicommand
 515:					
 516: 2219+4	8D8E  47      		ld b, a 
 517:					;; MIDI data byte
 518: 2223+13	8D8F  3A5188  		ld a, (midicount)
 519: 2236+4	8D92  B7      		or a 
 520: 2240+5+6	8D93  C8      		ret z
 521:				
 522:					;; note byte?
 523: 2245+7	8D94  FE01    		cp 1
 524: 2252+7+5	8D96  200C    		jr nz, velcheck
 525:				
 526: 2259+4	8D98  78      		ld a, b 
 527: 2263+13	8D99  325288  		ld (curnote), a
 528: 2276+7	8D9C  3E02    		ld a, 2 
 529: 2283+13	8D9E  325188  		ld (midicount), a
 530:				
 531: 2296+7	8DA1  3E00    		ld a, 0 
 532:				
 533: 2303+10	8DA3  C9      		ret
 534:				
 535:     -	8DA4          	velcheck:
 536: 2313+4	8DA4  78      		ld a, b
 537: 2317+13	8DA5  325388  		ld (curvel), a
 538:				
 539:					; signal message complete -> note / vel available
 540: 2330+7	8DA8  3E01    		ld a, 1
 541:				
 542: 2337+10	8DAA  C9      		ret 
 543:				
 544:     -	8DAB          	midicommand:	 
 545:				
 546: 2347+4	8DAB  47      		ld b, a 
 547: 2351+7	8DAC  3E00    		ld a, 0 
 548: 2358+13	8DAE  325188  		ld (midicount), a
 549:				
 550: 2371+4	8DB1  78      		ld a, b
 551:					;; note on? 
 552: 2375+7	8DB2  FE90    		cp $90 
 553: 2382+7+5	8DB4  2803    		jr z, midinoteon
 554:				
 555: 2389+7	8DB6  3E00    		ld a, 0
 556: 2396+10	8DB8  C9      		ret 
 557:				
 558:     -	8DB9          	midinoteon:	 
 559:				
 560:					;;  note on!
 561: 2406+7	8DB9  3E01    		ld a, 1
 562: 2413+13	8DBB  325188  		ld (midicount), a
 563:				
 564: 2426+7	8DBE  3E00    		ld a, 0
 565:					
 566: 2433+10	8DC0  C9      		ret	
 567:				
 568:				
 569:     -	8DC1          	help:
 570:				
 571: 2443+10	8DC1  21003C  		ld	hl,$3c00
 572: 2453+10	8DC4  11013C  		ld	de,$3c00+1
 573: 2463+10	8DC7  01FF03  		ld	bc,1024-1
 574: 2473+10	8DCA  3620    		ld	(hl),' '
 575: 2483+16+5	8DCC  EDB0    		ldir
 576:				
 577: 2499+10	8DCE  210484  		ld	hl,helpt
 578: 2509+10	8DD1  11003C  		ld	de,$3c00
 579: 2519+10	8DD4  010004  		ld	bc,1024 
 580: 2529+16+5	8DD7  EDB0    		ldir
 581:				
 582: 2545+17	8DD9  CD4900  		call @KEY
 583:					
 584: 2562+10	8DDC  C37D8B  		jp main2
 585:				
 586:     -	8DDF          	load:
 587: 2572+10	8DDF  C3A18B  		jp loop 
 588:				
 589:     -	8DE2          	save:
 590: 2582+10	8DE2  C3A18B  		jp loop 
 591:					
 592:     -	8DE5          	quit:
 593: 2592+17	8DE5  CD2D40  		call @EXIT
 594:					
 595:     -	8DE8          	nextbar:
 596: 2609+13	8DE8  3A4788  		ld a,(cursorx)
 597: 2622+10	8DEB  215088  		ld hl,gridres
 598: 2632+7	8DEE  46      		ld b,(hl)
 599: 2639+4	8DEF  80      		add a,b
 600: 2643+7	8DF0  FE40    		cp 64
 601: 2650+10	8DF2  D2038D  		jp nc, cont
 602: 2660+13	8DF5  324788  		ld (cursorx),a
 603: 2673+10	8DF8  215B8B  		ld hl,memcursorx 
 604: 2683+7	8DFB  77      		ld (hl),a
 605: 2690+10	8DFC  C3038D  		jp cont
 606:				
 607:     -	8DFF          	prevbar:
 608: 2700+13	8DFF  3A4788  		ld a,(cursorx)
 609: 2713+10	8E02  215088  		ld hl,gridres
 610: 2723+7	8E05  46      		ld b,(hl)
 611: 2730+4	8E06  90      		sub a,b
 612: 2734+10	8E07  DA038D  		jp c, cont
 613: 2744+13	8E0A  324788  		ld (cursorx),a
 614: 2757+10	8E0D  215B8B  		ld hl,memcursorx 
 615: 2767+7	8E10  77      		ld (hl),a
 616: 2774+10	8E11  C3038D  		jp cont
 617:				
 618:				setbar1x macro
 619:					ld (cursorx), a
 620:					ld hl,memcursorx 
 621:					ld (hl),a
 622:				
 623:					ld a, (cursory)
 624:					cp 9
 625:					jp c,cont
 626:					; else change y cursor 
 627:					sub 7 
 628:					ld (cursory),a
 629:					
 630:					ld a,(memcursory) 
 631:					sub 6
 632:					ld (memcursory),a
 633:				
 634:					jp cont
 635:					endm
 636:				
 637:				
 638:				setbar2x macro
 639:					ld (cursorx), a
 640:					ld hl,memcursorx 
 641:					ld (hl),a
 642:				
 643:					ld a, (cursory)
 644:					cp 10
 645:					jp nc,cont
 646:					; else change y cursor 
 647:					add 7 
 648:					ld (cursory),a
 649:					
 650:					ld a,(memcursory) 
 651:					add 6
 652:					ld (memcursory),a
 653:				
 654:					jp cont
 655:					endm 
 656:				
 657:     -	8E14          	bar1:
 658: 2784+7	8E14  3E00    		ld a,0
 659: 2791+123	8E16  32478821		setbar1x 
	              5B8B773A
	              4888FE09
	              DA038DD6
	              07324888
	              3A5C8BD6
	              06325C8B
	              C3038D
 660:					
 661:     -	8E35          	bar2:	
 662: 2914+7	8E35  3E10    		ld a,16
 663: 2921+123	8E37  32478821		setbar1x 
	              5B8B773A
	              4888FE09
	              DA038DD6
	              07324888
	              3A5C8BD6
	              06325C8B
	              C3038D
 664:				
 665:     -	8E56          	bar3:
 666: 3044+7	8E56  3E20    		ld a,32
 667: 3051+123	8E58  32478821		setbar1x 
	              5B8B773A
	              4888FE09
	              DA038DD6
	              07324888
	              3A5C8BD6
	              06325C8B
	              C3038D
 668:				
 669:     -	8E77          	bar4:
 670: 3174+7	8E77  3E30    		ld a,48
 671: 3181+123	8E79  32478821		setbar1x 
	              5B8B773A
	              4888FE09
	              DA038DD6
	              07324888
	              3A5C8BD6
	              06325C8B
	              C3038D
 672:				
 673:     -	8E98          	bar5:
 674: 3304+7	8E98  3E00    		ld a,0
 675: 3311+123	8E9A  32478821		setbar2x 
	              5B8B773A
	              4888FE0A
	              D2038DC6
	              07324888
	              3A5C8BC6
	              06325C8B
	              C3038D
 676:				
 677:     -	8EB9          	bar6:
 678: 3434+7	8EB9  3E10    		ld a,16
 679: 3441+123	8EBB  32478821		setbar2x
	              5B8B773A
	              4888FE0A
	              D2038DC6
	              07324888
	              3A5C8BC6
	              06325C8B
	              C3038D
 680:					
 681:     -	8EDA          	bar7:
 682: 3564+7	8EDA  3E20    		ld a,32
 683: 3571+123	8EDC  32478821		setbar2x
	              5B8B773A
	              4888FE0A
	              D2038DC6
	              07324888
	              3A5C8BC6
	              06325C8B
	              C3038D
 684:					
 685:     -	8EFB          	bar8:
 686: 3694+7	8EFB  3E30    		ld a,48
 687: 3701+123	8EFD  32478821		setbar2x 
	              5B8B773A
	              4888FE0A
	              D2038DC6
	              07324888
	              3A5C8BC6
	              06325C8B
	              C3038D
 688:				
 689:     -	8F1C          	faster:
 690: 3824+13	8F1C  3A4D88  		ld a,(tempo)
 691: 3837+7	8F1F  FE01    		cp 1 
 692: 3844+10	8F21  CA038D  		jp z,cont
 693:					
 694: 3854+4	8F24  3D      		dec a
 695: 3858+4	8F25  4F      		ld c,a
 696: 3862+13	8F26  324D88  		ld (tempo),a
 697: 3875+7	8F29  3E00    		ld a,0
 698: 3882+10	8F2B  214C88  		ld hl,delayc
 699: 3892+10	8F2E  3600    		ld (hl),0
 700: 3902+17	8F30  CD6D92  		call showtempo
 701: 3919+10	8F33  C3038D  		jp cont
 702:				
 703:     -	8F36          	faster1:
 704: 3929+13	8F36  3A4D88  		ld a,(tempo)
 705: 3942+7	8F39  FE11    		cp $11
 706: 3949+10	8F3B  DA038D  		jp c,cont
 707:					
 708: 3959+7	8F3E  D610    		sub $10
 709: 3966+4	8F40  4F      		ld c,a
 710: 3970+13	8F41  324D88  		ld (tempo),a
 711: 3983+7	8F44  3E00    		ld a,0
 712: 3990+10	8F46  214C88  		ld hl,delayc
 713: 4000+10	8F49  3600    		ld (hl),0
 714: 4010+17	8F4B  CD6D92  		call showtempo
 715: 4027+10	8F4E  C3038D  		jp cont
 716:					
 717:     -	8F51          	slower:
 718: 4037+13	8F51  3A4D88  		ld a,(tempo)
 719: 4050+7	8F54  FEFF    		cp a,255
 720: 4057+10	8F56  CA038D  		jp z,cont
 721:					
 722: 4067+4	8F59  3C      		inc a
 723: 4071+4	8F5A  4F      		ld c,a
 724: 4075+13	8F5B  324D88  		ld (tempo),a
 725: 4088+7	8F5E  3E00    		ld a,0
 726: 4095+10	8F60  214C88  		ld hl,delayc
 727: 4105+10	8F63  3600    		ld (hl),0
 728:				
 729: 4115+17	8F65  CD6D92  		call showtempo
 730: 4132+10	8F68  C3038D  		jp cont	
 731:				
 732:     -	8F6B          	slower1:
 733: 4142+13	8F6B  3A4D88  		ld a,(tempo)
 734: 4155+7	8F6E  FEF0    		cp a,$f0
 735: 4162+10	8F70  D2038D  		jp nc,cont
 736:					
 737: 4172+7	8F73  C610    		add $10
 738: 4179+4	8F75  4F      		ld c,a
 739: 4183+13	8F76  324D88  		ld (tempo),a
 740: 4196+7	8F79  3E00    		ld a,0
 741: 4203+10	8F7B  214C88  		ld hl,delayc
 742: 4213+10	8F7E  3600    		ld (hl),0
 743:				
 744: 4223+17	8F80  CD6D92  		call showtempo
 745: 4240+10	8F83  C3038D  		jp cont	
 746:				
 747:				testsoundx macro 
 748:					;; call gettrackdrum
 749:					;; ld b,a
 750:				
 751:					ld a,(curnote)
 752:					ld b, a
 753:					
 754:					ld a,$90+9
 755:					out (8),a
 756:				  
 757:					call short_delay
 758:				
 759:					ld a,b
 760:					out (8),a 
 761:				  
 762:					call short_delay  
 763:				  
 764:					ld a,127
 765:					out (8),a
 766:				  
 767:					endm 
 768:				
 769:     -	8F86          	instrup:
 770: 4250+17	8F86  CD8692  		call gettrackdrum
 771: 4267+4	8F89  3C      		inc a 
 772: 4271+7	8F8A  E67F    		and $7f
 773: 4278+7	8F8C  77      		ld (hl), a
 774: 4285+10	8F8D  C3038D  		jp cont 
 775:				
 776:     -	8F90          	instrdown:
 777: 4295+17	8F90  CD8692  		call gettrackdrum
 778: 4312+4	8F93  3D      		dec a 
 779: 4316+7	8F94  E67F    		and $7f
 780: 4323+7	8F96  77      		ld (hl), a
 781: 4330+10	8F97  C3038D  		jp cont
 782:				
 783:				restorecellx macro 
 784:					ld a,(memcursorx)
 785:					
 786:					ld hl,data
 787:					ld d,0
 788:					ld e,a
 789:					add hl,de	
 790:					ld a,(hl)
 791:					endm 
 792:				
 793:				setgridx macro
 794:					call memcursor
 795:					; ld (hl),SETSYM
 796:					ld a, (curnote)
 797:					add DISPMIDINOTEOFFSET 
 798:				
 799:					ld (hl), a 
 800:					ld hl,lastcur
 801:					; ld (hl),SETSYM
 802:					ld (hl), a
 803:					endm 
 804:				
 805:				erasegridx macro
 806:					call memcursor
 807:					ld a, (hl)
 808:					;;  erase
 809:					push hl
 810:					restorecellx 
 811:					pop hl
 812:					ld (hl),a
 813:					ld hl,lastcur
 814:					ld (hl),a 
 815:					endm 
 816:				
 817:				gettrackdrumx macro 
 818:					call gettracknr
 819:					dec a
 820:					ld hl,instracks
 821:					ld d,0
 822:					ld e,a
 823:					add hl, de 
 824:					ld a,(hl)
 825:					endm
 826:				
 827:				
 828:     -	8F9A          	setgridandsound:
 829:					
 830: 4340+102	8F9A  3A528847		testsoundx
	              3E99D308
	              CD4D9378
	              D308CD4D
	              933E7FD3
	              08
 831: 4442+61	8FAF  CD7C913A		setgridx 
	              5288C661
	              77214488
	              77
 832:				
 833: 4503+10	8FBC  C3038D  		jp cont 
 834:				
 835:     -	8FBF          	setgridandsoundkey:
 836:				
 837: 4513+17	8FBF  CD8692  		call gettrackdrum
 838: 4530+13	8FC2  325288  		ld (curnote), a 
 839:					
 840: 4543+102	8FC5  3A528847		testsoundx
	              3E99D308
	              CD4D9378
	              D308CD4D
	              933E7FD3
	              08
 841: 4645+61	8FDA  CD7C913A		setgridx 
	              5288C661
	              77214488
	              77
 842:				
 843: 4706+10	8FE7  C3038D  		jp cont 
 844:				
 845:     -	8FEA          	setgridandsoundr:
 846:					
 847: 4716+102	8FEA  3A528847		testsoundx
	              3E99D308
	              CD4D9378
	              D308CD4D
	              933E7FD3
	              08
 848: 4818+61	8FFF  CD7C913A		setgridx 
	              5288C661
	              77214488
	              77
 849:				
 850: 4879+10	900C  C9      		ret
 851:				
 852:     -	900D          	setgridandsoundkeyr:
 853:				
 854: 4889+17	900D  CD8692  		call gettrackdrum
 855: 4906+13	9010  325288  		ld (curnote), a 
 856:				
 857: 4919+102	9013  3A528847		testsoundx
	              3E99D308
	              CD4D9378
	              D308CD4D
	              933E7FD3
	              08
 858: 5021+61	9028  CD7C913A		setgridx 
	              5288C661
	              77214488
	              77
 859:				
 860: 5082+10	9035  C9      		ret
 861:				
 862:     -	9036          	setgrid:
 863:					
 864: 5092+61	9036  CD7C913A		setgridx 
	              5288C661
	              77214488
	              77
 865: 5153+10	9043  C3038D  		jp cont
 866:				
 867:     -	9046          	setgridkey:
 868:					
 869: 5163+17	9046  CD8692  		call gettrackdrum
 870: 5180+13	9049  325288  		ld (curnote), a 
 871:				
 872: 5193+61	904C  CD7C913A		setgridx 
	              5288C661
	              77214488
	              77
 873: 5254+10	9059  C3038D  		jp cont
 874:				
 875:     -	905C          	setgridr:
 876:				
 877: 5264+61	905C  CD7C913A		setgridx 
	              5288C661
	              77214488
	              77
 878: 5325+10	9069  C9      		ret
 879:				
 880:     -	906A          	setgridkeyr:
 881:				
 882: 5335+17	906A  CD8692  		call gettrackdrum
 883: 5352+13	906D  325288  		ld (curnote), a 
 884:				
 885: 5365+61	9070  CD7C913A		setgridx 
	              5288C661
	              77214488
	              77
 886: 5426+10	907D  C9      		ret
 887:				
 888:     -	907E          	erasegrid:
 889:					
 890: 5436+121	907E  CD7C917E		erasegridx 
	              E53A5B8B
	              21C48016
	              005F197E
	              E1772144
	              8877
 891: 5557+10	9094  C3038D  		jp cont
 892:				
 893:     -	9097          	erasegridr:
 894:					
 895: 5567+121	9097  CD7C917E		erasegridx 
	              E53A5B8B
	              21C48016
	              005F197E
	              E1772144
	              8877
 896: 5688+10	90AD  C9      		ret 
 897:				
 898:     -	90AE          	startstop:
 899: 5698+13	90AE  3A4A88  		ld a,(status)
 900: 5711+7	90B1  EE01    		xor 1
 901: 5718+13	90B3  324A88  		ld (status), a
 902: 5731+4	90B6  B7      		or a
 903: 5735+7+5	90B7  200E    		jr nz, showplay
 904:					
 905: 5742+10	90B9  117C3C  		ld de,$3c00 + 64 + 60
 906: 5752+10	90BC  210080  		ld hl,stopped 
 907: 5762+10	90BF  010100  		ld bc,1 
 908: 5772+16+5	90C2  EDB0    		ldir
 909: 5788+10	90C4  C3038D  		jp cont 
 910:     -	90C7          	showplay:
 911: 5798+10	90C7  117C3C  		ld de,$3c00 + 64 + 60
 912: 5808+10	90CA  210180  		ld hl,playing  
 913: 5818+10	90CD  010100  		ld bc,1
 914: 5828+16+5	90D0  EDB0    		ldir
 915: 5844+10	90D2  C3038D  		jp cont 
 916:				
 917:     -	90D5          	trackstatus:
 918: 5854+13	90D5  3A4B88  		ld a,(track)
 919: 5867+7	90D8  EE01    		xor 1
 920: 5874+13	90DA  324B88  		ld (track), a
 921: 5887+4	90DD  B7      		or a
 922: 5891+7+5	90DE  200E    		jr nz, showtrackstatus
 923:					
 924: 5898+10	90E0  117E3C  		ld de,$3c00 + 64 + 62
 925: 5908+10	90E3  210280  		ld hl,free 
 926: 5918+10	90E6  010100  		ld bc,1
 927: 5928+16+5	90E9  EDB0    		ldir
 928: 5944+10	90EB  C3038D  		jp cont
 929:					
 930:     -	90EE          	showtrackstatus:	
 931: 5954+10	90EE  117E3C  		ld de,$3c00 + 64 + 62
 932: 5964+10	90F1  210380  		ld hl,tracked   
 933: 5974+10	90F4  010100  		ld bc,1
 934: 5984+16+5	90F7  EDB0    		ldir
 935: 6000+10	90F9  C3038D  		jp cont 
 936:				
 937:				
 938:     -	90FC          	left:	
 939: 6010+13	90FC  3A4788  		ld a,(cursorx)
 940: 6023+4	90FF  B7      		or a
 941: 6027+10	9100  CA038D  		jp z, cont
 942: 6037+4	9103  3D      		dec a	
 943: 6041+13	9104  324788  		ld (cursorx),a
 944: 6054+10	9107  215B8B  		ld hl,memcursorx 
 945: 6064+7	910A  77      		ld (hl),a
 946: 6071+10	910B  C3038D  		jp cont
 947:     -	910E          	right:
 948: 6081+13	910E  3A4788  		ld a,(cursorx)
 949: 6094+7	9111  FE3F    		cp 63
 950: 6101+10	9113  CA038D  		jp z, cont
 951: 6111+4	9116  3C      		inc a
 952: 6115+13	9117  324788  		ld (cursorx),a
 953: 6128+10	911A  215B8B  		ld hl,memcursorx 
 954: 6138+7	911D  77      		ld (hl),a
 955: 6145+10	911E  C3038D  		jp cont
 956:     -	9121          	up:
 957: 6155+13	9121  3A4888  		ld a,(cursory)
 958: 6168+7	9124  FE03    		cp 3
 959: 6175+10	9126  CA038D  		jp z, cont
 960: 6185+7	9129  FE0A    		cp 10
 961: 6192+7+5	912B  2004    		jr nz,up1
 962: 6199+7	912D  3E08    		ld a,8
 963: 6206+12	912F  1801    		jr up2
 964:     -	9131          	up1:	 
 965: 6218+4	9131  3D      		dec a
 966:				
 967:     -	9132          	up2:	
 968: 6222+13	9132  324888  		ld (cursory),a
 969:				
 970: 6235+10	9135  215C8B  		ld hl,memcursory
 971: 6245+7	9138  7E      		ld a,(hl)
 972: 6252+4	9139  3D      		dec a
 973: 6256+7	913A  77      		ld (hl),a 
 974: 6263+10	913B  C3038D  		jp cont
 975:				
 976:     -	913E          	down:
 977: 6273+13	913E  3A4888  		ld a,(cursory)
 978: 6286+7	9141  FE0F    		cp 15
 979: 6293+10	9143  CA038D  		jp z, cont
 980: 6303+7	9146  FE08    		cp 8
 981: 6310+7+5	9148  2004    		jr nz,down1
 982: 6317+7	914A  3E0A    		ld a,10
 983: 6324+12	914C  1801    		jr down2
 984:     -	914E          	down1:	
 985: 6336+4	914E  3C      		inc a
 986:     -	914F          	down2:	 
 987: 6340+13	914F  324888  		ld (cursory),a
 988:					
 989: 6353+10	9152  215C8B  		ld hl,memcursory 
 990: 6363+7	9155  7E      		ld a,(hl)
 991: 6370+4	9156  3C      		inc a
 992: 6374+7	9157  77      		ld (hl),a
 993: 6381+10	9158  C3038D  		jp cont
 994:				
 995:					
 996:     -	915B          	cursor:
 997: 6391+13	915B  3A4988  		ld a,(blink)
 998: 6404+4	915E  3C      		inc a
 999: 6408+13	915F  324988  		ld (blink),a
1000: 6421+10	9162  21003C  		ld hl,$3c00
1001: 6431+13	9165  3A4788  		ld a,(cursorx)
1002: 6444+4	9168  B7      		or a
1003: 6448+7+5	9169  2804    		jr z, moveyup
1004: 6455+4	916B  47      		ld b,a
1005:     -	916C          	movex:	
1006: 6459+6	916C  23      		inc hl 
1007: 6465+8+5	916D  10FD    		djnz movex
1008:     -	916F          	moveyup:	
1009: 6473+13	916F  3A4888  		ld a,(cursory)
1010: 6486+4	9172  B7      		or a
1011: 6490+5+6	9173  C8      		ret z
1012: 6495+4	9174  47      		ld b,a
1013: 6499+10	9175  114000  		ld de,64
1014:     -	9178          	movey:
1015: 6509+11	9178  19      		add hl,de 
1016: 6520+8+5	9179  10FD    		djnz movey
1017: 6528+10	917B  C9      		ret 
1018:				
1019:     -	917C          	memcursor:
1020: 6538+10	917C  215588  		ld hl,tracks1
1021: 6548+13	917F  3A5B8B  		ld a,(memcursorx)
1022: 6561+4	9182  B7      		or a
1023: 6565+7+5	9183  2804    		jr z, mmoveyup
1024: 6572+4	9185  47      		ld b,a
1025:     -	9186          	mmovex:	
1026: 6576+6	9186  23      		inc hl 
1027: 6582+8+5	9187  10FD    		djnz mmovex
1028:     -	9189          	mmoveyup:	
1029: 6590+13	9189  3A5C8B  		ld a,(memcursory)
1030: 6603+4	918C  B7      		or a
1031: 6607+5+6	918D  C8      		ret z
1032: 6612+4	918E  47      		ld b,a
1033: 6616+10	918F  114000  		ld de,64
1034:     -	9192          	mmovey:
1035: 6626+11	9192  19      		add hl,de 
1036: 6637+8+5	9193  10FD    		djnz mmovey
1037: 6645+10	9195  C9      		ret 
1038:				
1039:					
1040: 6655+10	9196  010000  	dly.01:	ld	bc,d10000th
1041:     -	0000          		sett	0
1042:    0+6	9199  0B      	dly:	dec	bc
1043:    6+4	919A  78      		ld	a,b
1044:   10+4	919B  B1      		or	c
1045:   14+10	919C  C29991  		jp	nz,dly
1046:   24+10	919F  C9      		ret
1047:				
1048:				
1049:     -	91A0          	nextnote:
1050:				
1051:   34+13	91A0  3A5E8B  		ld a,(qtrackpos)
1052:   47+4	91A3  3C      		inc a
1053:   51+4	91A4  47      		ld b,a
1054:					
1055:   55+13	91A5  3A4F88  		ld a,(numticks)
1056:   68+4	91A8  B8      		cp b
1057:   72+4	91A9  78      		ld a,b
1058:   76+7+5	91AA  2002    		jr nz,nextnote0
1059:				
1060:					; max tick number reached, set to 0
1061:   83+7	91AC  3E00    		ld a, 0
1062:				
1063:     -	91AE          	nextnote0:
1064:   90+13	91AE  325E8B  		ld (qtrackpos),a
1065:				
1066:  103+4	91B1  47      		ld b, a
1067:  107+13	91B2  3A5488  		ld a, (quantpat)
1068:  120+4	91B5  A0      		and b
1069:  124+13	91B6  325D8B  		ld (trackpos),a
1070:				
1071:  137+4	91B9  B8      		cp b
1072:  141+7+5	91BA  2810    		jr z, nextnote1
1073:				
1074:					;; ENTER sample keyboard; this one makes noise,
1075:					;; ONLY sample when (qtrackpos) = (trackpos)
1076:				
1077:  148+17	91BC  CD848D  		call midiin
1078:  165+7	91BF  FE01    		cp 1 
1079:  172+10+7	91C1  CCEA8F  		call z,setgridandsoundr
1080:				
1081:  182+20	91C4  3A4038E6		keydown k_enter 
	              01
1082:  202+10+7	91C9  C40D90  		call nz,setgridandsoundkeyr
1083:				
1084:     -	91CC          	nextnote1:
1085:				
1086:					;; sample keyboard
1087:				
1088:  212+20	91CC  3A4038E6		keydown k_space 
	              80
1089:  232+10+7	91D1  C46A90  		call nz,setgridkeyr
1090:				
1091:  242+20	91D4  3A4038E6		keydown k_clear
	              02
1092:  262+10+7	91D9  C49790  		call nz,erasegridr
1093:				
1094:  272+13	91DC  3A5D8B  		ld a, (trackpos)
1095:				
1096:  285+8	91DF  CB7F    		bit 7,a
1097:  293+5+6	91E1  C8      		ret z
1098:					
1099:  298+7	91E2  3E00    		ld a,0
1100:  305+13	91E4  325E8B  		ld (qtrackpos),a
1101:  318+13	91E7  325D8B  		ld (trackpos),a
1102:					
1103:  331+10	91EA  C9      		ret
1104:				
1105:     -	91EB          	showplaycursor:
1106:					
1107:  341+10	91EB  218480  		ld	hl,title+2*64 
1108:  351+10	91EE  11803C  		ld	de,$3c00+2*64 
1109:  361+10	91F1  014000  		ld	bc,64 
1110:  371+16+5	91F4  EDB0    		ldir
1111:				
1112:  387+10	91F6  214482  		ld	hl,title+9*64 
1113:  397+10	91F9  11403E  		ld	de,$3c00+9*64 
1114:  407+10	91FC  014000  		ld	bc,64 
1115:  417+16+5	91FF  EDB0    		ldir
1116:				
1117:  433+13	9201  3A5E8B  		ld a,(qtrackpos)
1118:					
1119:  446+10	9204  21803C  		ld hl,$3c00+2*64
1120:  456+4	9207  5F      		ld e,a
1121:  460+7	9208  1600    		ld d,0 
1122:  467+11	920A  19      		add hl,de
1123:				
1124:  478+8	920B  CB77    		bit 6,a
1125:  486+7+5	920D  2003    		jr nz,showcurtrack2
1126:					
1127:  493+10	920F  36AA    		ld (hl),POSMARKSYM
1128:  503+10	9211  C9      		ret
1129:     -	9212          	showcurtrack2:
1130:  513+10	9212  118001  		ld de,6*64
1131:  523+11	9215  19      		add hl,de
1132:  534+10	9216  36AA    		ld (hl),POSMARKSYM
1133:  544+10	9218  C9      		ret
1134:					
1135:					
1136:     -	0000          	d10000th	equ	1774080 / t($) / 10000
1137:				
1138:					  
1139:     -	9219          	screenupdate:
1140:					
1141:					;;  swap in track 1 
1142:  554+10	9219  215588  		ld	hl,tracks1	
1143:  564+10	921C  11C03C  		ld	de,$3c00+3*64 
1144:  574+10	921F  018001  		ld	bc,6*64
1145:  584+16+5	9222  EDB0    		ldir
1146:				
1147:					;;  swap in track 1 
1148:  600+10	9224  21D589  		ld	hl,tracks2 
1149:  610+10	9227  11803E  		ld	de,$3c00+10*64 
1150:  620+10	922A  018001  		ld	bc,6*64
1151:  630+16+5	922D  EDB0    		ldir
1152:				
1153:  646+10	922F  C9      		ret
1154:				
1155:     -	9230          	showcursor:
1156:				
1157:  656+16	9230  2A4588  		ld hl,(lastcurpos)
1158:  672+13	9233  3A4488  		ld a,(lastcur)
1159:  685+7	9236  77      		ld (hl),a
1160:  692+17	9237  CD5B91  		call cursor
1161:  709+16	923A  224588  		ld (lastcurpos),hl
1162:  725+7	923D  7E      		ld a,(hl)
1163:  732+13	923E  324488  		ld (lastcur),a
1164:					
1165:  745+13	9241  3A4988  		ld a,(blink)
1166:  758+7	9244  FE7F    		cp a,127
1167:  765+7+5	9246  3803    		jr c,cur2
1168:  772+10	9248  3658    		ld (hl), CURSYM 
1169:  782+10	924A  C9      		ret 
1170:				
1171:     -	924B          	cur2:
1172:  792+11	924B  E5      		push hl
1173:  803+52	924C  3A5B8B21		restorecellx
	              C4801600
	              5F197E
1174:  855+10	9257  E1      		pop hl 
1175:  865+10	9258  C9      		ret
1176:					
1177:					
1178:     -	9259          	byte2ascii: 			; input c, output de ASCII 
1179:  875+4	9259  79      	   ld a, c
1180:  879+4	925A  1F      	   rra
1181:  883+4	925B  1F      	   rra
1182:  887+4	925C  1F      	   rra
1183:  891+4	925D  1F      	   rra
1184:  895+17	925E  CD6392  	   call convnibble 
1185:  912+4	9261  57      	   ld d, a	
1186:  916+4	9262  79      	   ld  a,c
1187:     -	9263          	convnibble:
1188:  920+7	9263  E60F    	   and  $0F
1189:  927+7	9265  C690    	   add  a,$90
1190:  934+4	9267  27      	   daa
1191:  938+7	9268  CE40    	   adc  a,$40
1192:  945+4	926A  27      	   daa
1193:  949+4	926B  5F      	   ld e, a	
1194:  953+10	926C  C9      	   ret
1195:				
1196:     -	926D          	showtempo:
1197:  963+13	926D  3A4D88  		ld a,(tempo)
1198:  976+4	9270  4F      		ld c,a 
1199:  980+10	9271  21503C  		ld hl,$3c00+64+16
1200:  990+17	9274  CD5992  		call byte2ascii
1201: 1007+7	9277  72      		ld (hl),d
1202: 1014+6	9278  23      		inc hl
1203: 1020+7	9279  73      		ld (hl),e
1204: 1027+10	927A  C9      		ret
1205:				
1206:     -	927B          	gettracknr:
1207: 1037+13	927B  3A5C8B  		ld a,(memcursory)
1208: 1050+7	927E  C601    		add 1
1209: 1057+7	9280  FE07    		cp 7
1210: 1064+5+6	9282  D8      		ret c
1211: 1069+7	9283  D606    		sub 6
1212: 1076+10	9285  C9      		ret
1213:				
1214:				
1215:				
1216:     -	9286          	gettrackdrum:
1217: 1086+60	9286  CD7B923D		gettrackdrumx
	              21558B16
	              005F197E
1218: 1146+10	9292  C9      		ret
1219:				
1220:     -	9293          	gettrackdrumreg: ; input: e register, starting at 0
1221: 1156+10	9293  21558B  		ld hl,instracks
1222: 1166+7	9296  1600    		ld d,0
1223: 1173+11	9298  19      		add hl, de 
1224: 1184+7	9299  46      		ld b,(hl)
1225: 1191+10	929A  C9      		ret
1226:				
1227:     -	929B          	showtrackdrum:
1228: 1201+17	929B  CD8692  		call gettrackdrum
1229: 1218+4	929E  4F      		ld c, a
1230: 1222+10	929F  21613C  		ld hl,$3c00+64+33
1231: 1232+17	92A2  CD5992  		call byte2ascii
1232: 1249+7	92A5  72      		ld (hl),d
1233: 1256+6	92A6  23      		inc hl
1234: 1262+7	92A7  73      		ld (hl),e
1235: 1269+10	92A8  C9      		ret
1236:				
1237:     -	92A9          	showtrack:
1238: 1279+17	92A9  CD7B92  		call gettracknr 
1239: 1296+4	92AC  4F      		ld c,a 
1240: 1300+10	92AD  21473C  		ld hl,$3c00+64+7
1241: 1310+17	92B0  CD6392  		call convnibble 
1242: 1327+7	92B3  73      		ld (hl),e
1243: 1334+10	92B4  C9      		ret
1244:				
1245:     -	92B5          	playnotes:
1246: 1344+13	92B5  3A5E8B  		ld a,(qtrackpos)
1247:					
1248: 1357+8	92B8  CB77    		bit 6,a
1249: 1365+7+5	92BA  2005    		jr nz,playhightracks ; > 64  
1250:					
1251: 1372+10	92BC  215588  		ld hl,tracks1
1252:					
1253: 1382+12	92BF  1803    		jr playtracks
1254:				
1255:     -	92C1          	playhightracks:
1256:				
1257: 1394+10	92C1  21D589  		ld hl,tracks2
1258:				
1259:     -	92C4          	playtracks: 
1260:					; add note index
1261:					; clear bit 6
1262: 1404+8	92C4  CBB7    		res 6,a
1263: 1412+4	92C6  5F      		ld e,a
1264: 1416+7	92C7  1600    		ld d,0
1265: 1423+11	92C9  19      		add hl,de
1266: 1434+10	92CA  014000  		ld bc,64
1267:				
1268: 1444+11	92CD  E5      		push hl
1269: 1455+11	92CE  C5      		push bc
1270: 1466+7	92CF  4E      		ld c,(hl) ; -> c is on or off
1271: 1473+7	92D0  1600    		ld d,0
1272: 1480+7	92D2  1E00    		ld e,0 ; e is track number 
1273:					; call gettrackdrumreg ; -> b is drum note 
1274: 1487+17	92D4  CD1B93  		call playnote
1275:				
1276: 1504+10	92D7  C1      		pop bc
1277: 1514+10	92D8  E1      		pop hl
1278:					
1279: 1524+11	92D9  09      		add hl,bc
1280:				
1281: 1535+11	92DA  E5      		push hl
1282: 1546+11	92DB  C5      		push bc
1283:				
1284: 1557+7	92DC  4E      		ld c,(hl)
1285: 1564+7	92DD  1600    		ld d,0
1286: 1571+7	92DF  1E01    		ld e,1 
1287:					; call gettrackdrumreg 
1288: 1578+17	92E1  CD1B93  		call playnote
1289:				
1290: 1595+10	92E4  C1      		pop bc
1291: 1605+10	92E5  E1      		pop hl
1292:				
1293: 1615+11	92E6  09      		add hl,bc
1294:				
1295: 1626+11	92E7  E5      		push hl
1296: 1637+11	92E8  C5      		push bc
1297:					
1298: 1648+7	92E9  4E      		ld c,(hl) 
1299: 1655+7	92EA  1600    		ld d,0
1300: 1662+7	92EC  1E02    		ld e,2
1301:					; call gettrackdrumreg 
1302: 1669+17	92EE  CD1B93  		call playnote
1303:				
1304: 1686+10	92F1  C1      		pop bc
1305: 1696+10	92F2  E1      		pop hl
1306:				
1307: 1706+11	92F3  09      		add hl,bc
1308:				
1309: 1717+11	92F4  E5      		push hl
1310: 1728+11	92F5  C5      		push bc
1311:				
1312: 1739+7	92F6  4E      		ld c,(hl) 
1313: 1746+7	92F7  1600    		ld d,0
1314: 1753+7	92F9  1E03    		ld e,3 
1315:					; call gettrackdrumreg 
1316: 1760+17	92FB  CD1B93  		call playnote
1317:				
1318: 1777+10	92FE  C1      		pop bc
1319: 1787+10	92FF  E1      		pop hl
1320:				
1321: 1797+11	9300  09      		add hl,bc
1322:				
1323: 1808+11	9301  E5      		push hl
1324: 1819+11	9302  C5      		push bc
1325:				
1326: 1830+7	9303  4E      		ld c,(hl) 
1327: 1837+7	9304  1600    		ld d,0
1328: 1844+7	9306  1E04    		ld e,4 
1329:					; call gettrackdrumreg 
1330: 1851+17	9308  CD1B93  		call playnote
1331:				
1332: 1868+10	930B  C1      		pop bc
1333: 1878+10	930C  E1      		pop hl
1334:					
1335: 1888+11	930D  09      		add hl,bc
1336:				
1337: 1899+11	930E  E5      		push hl
1338: 1910+11	930F  C5      		push bc
1339:				
1340: 1921+7	9310  4E      		ld c,(hl) 
1341: 1928+7	9311  1600    		ld d,0
1342: 1935+7	9313  1E05    		ld e,5 
1343:					; call gettrackdrumreg 
1344: 1942+17	9315  CD1B93  		call playnote
1345:				
1346: 1959+10	9318  C1      		pop bc	
1347: 1969+10	9319  E1      		pop hl
1348:					
1349: 1979+10	931A  C9      		ret
1350:					
1351:					
1352:     -	931B          	playnote: ; input note on / off in c
1353:				
1354: 1989+4	931B  79      		ld a, c
1355:				
1356:				        ; cp SETSYM
1357:					; ret nz
1358: 1993+7	931C  FE62    		cp DISPMIDINOTEOFFSET+1 
1359: 2000+5+6	931E  D8      		ret c 
1360:				
1361: 2005+7	931F  3E99    		ld a,$90+9
1362: 2012+11	9321  D308    		out (8),a
1363:				  
1364: 2023+17	9323  CD4D93  		call short_delay
1365:				
1366: 2040+4	9326  79      		ld a,c
1367: 2044+7	9327  D661    		sub DISPMIDINOTEOFFSET		
1368: 2051+11	9329  D308    		out (8),a 
1369:				  
1370: 2062+17	932B  CD4D93  		call short_delay  
1371:				  
1372: 2079+7	932E  3E7F    		ld a,127
1373: 2086+11	9330  D308    		out (8),a
1374:				  
1375: 2097+10	9332  C9      		ret 
1376:					
1377:     -	9333          	showgridres:
1378: 2107+13	9333  3A5088  		ld a,(gridres)
1379: 2120+4	9336  4F      		ld c, a
1380: 2124+10	9337  21723C  		ld hl,$3c00+64+50
1381: 2134+17	933A  CD5992  		call byte2ascii
1382: 2151+7	933D  72      		ld (hl),d
1383: 2158+6	933E  23      		inc hl
1384: 2164+7	933F  73      		ld (hl),e
1385: 2171+10	9340  C9      		ret
1386:				
1387:     -	9341          	showbars:
1388: 2181+13	9341  3A4E88  		ld a,(numbars)
1389: 2194+4	9344  4F      		ld c, a
1390: 2198+10	9345  216A3C  		ld hl,$3c00+64+42
1391: 2208+17	9348  CD6392  		call convnibble
1392: 2225+7	934B  73      		ld (hl),e
1393: 2232+10	934C  C9      		ret
1394:				
1395:				
1396:     -	934D          	short_delay:
1397: 2242+10	934D  11FF00  	    ld de,$00ff
1398:     -	9350          	delloop: 
1399: 2252+6	9350  1B      	    dec de
1400: 2258+4	9351  7A      	    ld a,d
1401: 2262+4	9352  B3      	    or e
1402: 2266+10	9353  C25093  	    jp nz,delloop
1403: 2276+10	9356  C9      	    ret 
1404:				
1405:     -	8B5F          		end main 



Statistics:

     4	passes
     0	jr promotions
   199	symbols
  4183	bytes

    29	macro calls
  1040	macro bytes
     0	invented symbols



Symbol Table:

@DSP           =33        51
@DSPLY         =4467      17511
@EXIT          =402D      16429
@KBD           =2B        43
@KEY           =49        73
CURSYM         =58        88
DISPMIDINOTEOFFSET=61        97
ENTER          =0D        13
KCURDOWN       =0A        10
KCURLEFT       =08        8
KCURRIGHT      =09        9
KCURUP         =5B        91
POSMARKSYM     =AA        170
SETSYM         =8F        143
bar1            8E14      36372
bar2            8E35      36405
bar3            8E56      36438
bar4            8E77      36471
bar5            8E98      36504
bar6            8EB9      36537
bar7            8EDA      36570
bar8            8EFB      36603
blink           8849      34889
byte2ascii      9259      37465
chgnumbars      8D6C      36204
chgridres       8D15      36117
chgridres1      8D20      36128
cont            8D03      36099
convnibble      9263      37475
countticks      8D7A      36218
cur1            8C26      35878
cur2            924B      37451
curnote         8852      34898
cursor          915B      37211
cursorx         8847      34887
cursory         8848      34888
curvel          8853      34899
d10000th       =00        0
data            80C4      32964
delayc          884C      34892
delloop         9350      37712
dly             9199      37273
dly.01          9196      37270
down            913E      37182
down1           914E      37198
down2           914F      37199
erasegrid       907E      36990
erasegridr      9097      37015
faster          8F1C      36636
faster1         8F36      36662
free            8002      32770
gettrackdrum    9286      37510
gettrackdrumreg 9293      37523
gettracknr      927B      37499
gridres         8850      34896
gridres16       8D53      36179
gridres2        8D2F      36143
gridres32       8D5F      36191
gridres4        8D3B      36155
gridres8        8D47      36167
help            8DC1      36289
helpt           8404      33796
instracks       8B55      35669
instrdown       8F90      36752
instrup         8F86      36742
k_0            =00381001  3674113
k_1            =00381002  3674114
k_2            =00381004  3674116
k_3            =00381008  3674120
k_4            =00381010  3674128
k_5            =00381020  3674144
k_6            =00381040  3674176
k_7            =00381080  3674240
k_8            =00382001  3678209
k_9            =00382002  3678210
k_@            =00380101  3670273
k_A            =00380102  3670274
k_B            =00380104  3670276
k_C            =00380108  3670280
k_D            =00380110  3670288
k_E            =00380120  3670304
k_F            =00380140  3670336
k_G            =00380180  3670400
k_H            =00380201  3670529
k_I            =00380202  3670530
k_J            =00380204  3670532
k_K            =00380208  3670536
k_L            =00380210  3670544
k_M            =00380220  3670560
k_N            =00380240  3670592
k_O            =00380280  3670656
k_P            =00380401  3671041
k_Q            =00380402  3671042
k_R            =00380404  3671044
k_S            =00380408  3671048
k_T            =00380410  3671056
k_U            =00380420  3671072
k_V            =00380440  3671104
k_W            =00380480  3671168
k_X            =00380801  3672065
k_Y            =00380802  3672066
k_Z            =00380804  3672068
k_break        =00384004  3686404
k_clear        =00384002  3686402
k_colon        =00382004  3678212
k_comma        =00382010  3678224
k_dash         =00382020  3678240
k_dot          =00382040  3678272
k_down         =00384010  3686416
k_enter        =00384001  3686401
k_left         =00384020  3686432
k_right        =00384040  3686464
k_semi         =00382008  3678216
k_shift        =00388001  3702785
k_slash        =00382080  3678336
k_space        =00384080  3686528
k_up           =00384008  3686408
keyscan         8C3D      35901
keyscan1        8C5E      35934
lastcur         8844      34884
lastcurpos      8845      34885
left            90FC      37116
load            8DDF      36319
loop            8BA1      35745
main            8B5F      35679
main2           8B7D      35709
memcursor       917C      37244
memcursorx      8B5B      35675
memcursory      8B5C      35676
midicommand     8DAB      36267
midicount       8851      34897
midiin          8D84      36228
midinoteon      8DB9      36281
mmovex          9186      37254
mmovey          9192      37266
mmoveyup        9189      37257
movex           916C      37228
movey           9178      37240
moveyup         916F      37231
nextbar         8DE8      36328
nextnote        91A0      37280
nextnote0       91AE      37294
nextnote1       91CC      37324
nostep          8C18      35864
numbars         884E      34894
numticks        884F      34895
playhightracks  92C1      37569
playing         8001      32769
playnote        931B      37659
playnotes       92B5      37557
playtracks      92C4      37572
prevbar         8DFF      36351
qtrackpos       8B5E      35678
quantpat        8854      34900
quit            8DE5      36325
right           910E      37134
save            8DE2      36322
scan            8C2E      35886
scancont        8C55      35925
scancont1       8C65      35941
screenupdate    9219      37401
setgrid         9036      36918
setgridandsound 8F9A      36762
setgridandsoundkey 8FBF      36799
setgridandsoundkeyr 900D      36877
setgridandsoundr 8FEA      36842
setgridkey      9046      36934
setgridkeyr     906A      36970
setgridr        905C      36956
short_delay     934D      37709
showbars        9341      37697
showcursor      9230      37424
showcurtrack2   9212      37394
showgridres     9333      37683
showplay        90C7      37063
showplaycursor  91EB      37355
showtempo       926D      37485
showtrack       92A9      37545
showtrackcur    8C0E      35854
showtrackdrum   929B      37531
showtrackstatus 90EE      37102
slower          8F51      36689
slower1         8F6B      36715
startstop       90AE      37038
status          884A      34890
stopped         8000      32768
tempo           884D      34893
title           8004      32772
track           884B      34891
trackcury       8BF2      35826
tracked         8003      32771
trackpos        8B5D      35677
tracks1         8855      34901
tracks2         89D5      35285
trackstatus     90D5      37077
up              9121      37153
up1             9131      37169
up2             9132      37170
velcheck        8DA4      36260
