   1:				; TRACKER Version 1.5
   2:				; to do: mute tracks, patterns + song mode, save, load
   3:				
   4:				
   5:     -	8000          		org $8000
   6:				
   7:     -	0061          	DISPMIDINOTEOFFSET equ $61 ; 0 -> 'a' 
   8:				
   9:     -	00AA          	POSMARKSYM equ	$aa
  10:     -	008F          	SETSYM 	equ	$8f
  11:     -	0058          	CURSYM 	equ	'X'
  12:     -	000D          	ENTER	equ	$0d ; @DSPLY with newline
  13:				
  14:     -	0008          	KCURLEFT	equ 8
  15:     -	0009          	KCURRIGHT	equ 9
  16:     -	005B          	KCURUP		equ 91
  17:     -	000A          	KCURDOWN	equ 10
  18:				
  19:     -	4467          	@DSPLY		equ	$4467
  20:     -	402D          	@EXIT		equ	$402d
  21:     -	002B          	@KBD    	equ 	$002b 
  22:     -	0049          	@KEY    	equ 	$0049 
  23:     -	0033          	@DSP    	equ 	$0033
  24:				
  25:     -	8000  53      	stopped: ascii   'S'
  26:     -	8001  50      	playing: ascii   'P'
  27:     -	8002  46      	free: 	 ascii   'F'
  28:     -	8003  54      	tracked: ascii   'T'
  29:				
  30:				
  31:     -	8004  2A2A2A2A	title:	ascii   '***** MIDI/80 TRACKER  V1.5 - (C) 2024-2025 BY LAMBDAMIKEL *****'
	              2A204D49
	              44492F38
	              30205452
	              41434B45
	              52202056
	              312E3520
	              2D202843
	              29203230
	              32342D32
	              30323520
	              4259204C
	              414D4244
	              414D494B
	              454C202A
	              2A2A2A2A
  32:     -	8044  5041543A		ascii   'PAT:A SF | TRACK:1 SPEED:-- | B:8 S:04 | C:0 I:01 N:24 V:7F G:04'
	              41205346
	              207C2054
	              5241434B
	              3A312053
	              50454544
	              3A2D2D20
	              7C20423A
	              3820533A
	              3034207C
	              20433A30
	              20493A30
	              31204E3A
	              32342056
	              3A374620
	              473A3034
  33:     -	8084  313D3D3D		ascii	'1===-===+===-===2===-===+===-===3===-===+===-===4===-===+===-===' 
	              2D3D3D3D
	              2B3D3D3D
	              2D3D3D3D
	              323D3D3D
	              2D3D3D3D
	              2B3D3D3D
	              2D3D3D3D
	              333D3D3D
	              2D3D3D3D
	              2B3D3D3D
	              2D3D3D3D
	              343D3D3D
	              2D3D3D3D
	              2B3D3D3D
	              2D3D3D3D
  34:     -	80C4  212E2E2E	data:	ascii   '!...-...+...-...!...-...+...-...!...-...+...-...!...-...+...-...'
	              2D2E2E2E
	              2B2E2E2E
	              2D2E2E2E
	              212E2E2E
	              2D2E2E2E
	              2B2E2E2E
	              2D2E2E2E
	              212E2E2E
	              2D2E2E2E
	              2B2E2E2E
	              2D2E2E2E
	              212E2E2E
	              2D2E2E2E
	              2B2E2E2E
	              2D2E2E2E
  35:     -	8104  212E2E2E		ascii   '!...-...+...-...!...-...+...-...!...-...+...-...!...-...+...-...'
	              2D2E2E2E
	              2B2E2E2E
	              2D2E2E2E
	              212E2E2E
	              2D2E2E2E
	              2B2E2E2E
	              2D2E2E2E
	              212E2E2E
	              2D2E2E2E
	              2B2E2E2E
	              2D2E2E2E
	              212E2E2E
	              2D2E2E2E
	              2B2E2E2E
	              2D2E2E2E
  36:     -	8144  212E2E2E		ascii   '!...-...+...-...!...-...+...-...!...-...+...-...!...-...+...-...'
	              2D2E2E2E
	              2B2E2E2E
	              2D2E2E2E
	              212E2E2E
	              2D2E2E2E
	              2B2E2E2E
	              2D2E2E2E
	              212E2E2E
	              2D2E2E2E
	              2B2E2E2E
	              2D2E2E2E
	              212E2E2E
	              2D2E2E2E
	              2B2E2E2E
	              2D2E2E2E
  37:     -	8184  212E2E2E		ascii   '!...-...+...-...!...-...+...-...!...-...+...-...!...-...+...-...'
	              2D2E2E2E
	              2B2E2E2E
	              2D2E2E2E
	              212E2E2E
	              2D2E2E2E
	              2B2E2E2E
	              2D2E2E2E
	              212E2E2E
	              2D2E2E2E
	              2B2E2E2E
	              2D2E2E2E
	              212E2E2E
	              2D2E2E2E
	              2B2E2E2E
	              2D2E2E2E
  38:     -	81C4  212E2E2E		ascii   '!...-...+...-...!...-...+...-...!...-...+...-...!...-...+...-...'
	              2D2E2E2E
	              2B2E2E2E
	              2D2E2E2E
	              212E2E2E
	              2D2E2E2E
	              2B2E2E2E
	              2D2E2E2E
	              212E2E2E
	              2D2E2E2E
	              2B2E2E2E
	              2D2E2E2E
	              212E2E2E
	              2D2E2E2E
	              2B2E2E2E
	              2D2E2E2E
  39:     -	8204  212E2E2E		ascii   '!...-...+...-...!...-...+...-...!...-...+...-...!...-...+...-...'
	              2D2E2E2E
	              2B2E2E2E
	              2D2E2E2E
	              212E2E2E
	              2D2E2E2E
	              2B2E2E2E
	              2D2E2E2E
	              212E2E2E
	              2D2E2E2E
	              2B2E2E2E
	              2D2E2E2E
	              212E2E2E
	              2D2E2E2E
	              2B2E2E2E
	              2D2E2E2E
  40:     -	8244  353D3D3D		ascii	'5===-===+===-===6===-===+===-===7===-===+===-===8===-===+===-===' 
	              2D3D3D3D
	              2B3D3D3D
	              2D3D3D3D
	              363D3D3D
	              2D3D3D3D
	              2B3D3D3D
	              2D3D3D3D
	              373D3D3D
	              2D3D3D3D
	              2B3D3D3D
	              2D3D3D3D
	              383D3D3D
	              2D3D3D3D
	              2B3D3D3D
	              2D3D3D3D
  41:     -	8284  212E2E2E		ascii   '!...-...+...-...!...-...+...-...!...-...+...-...!...-...+...-...'
	              2D2E2E2E
	              2B2E2E2E
	              2D2E2E2E
	              212E2E2E
	              2D2E2E2E
	              2B2E2E2E
	              2D2E2E2E
	              212E2E2E
	              2D2E2E2E
	              2B2E2E2E
	              2D2E2E2E
	              212E2E2E
	              2D2E2E2E
	              2B2E2E2E
	              2D2E2E2E
  42:     -	82C4  212E2E2E		ascii   '!...-...+...-...!...-...+...-...!...-...+...-...!...-...+...-...'
	              2D2E2E2E
	              2B2E2E2E
	              2D2E2E2E
	              212E2E2E
	              2D2E2E2E
	              2B2E2E2E
	              2D2E2E2E
	              212E2E2E
	              2D2E2E2E
	              2B2E2E2E
	              2D2E2E2E
	              212E2E2E
	              2D2E2E2E
	              2B2E2E2E
	              2D2E2E2E
  43:     -	8304  212E2E2E		ascii   '!...-...+...-...!...-...+...-...!...-...+...-...!...-...+...-...'
	              2D2E2E2E
	              2B2E2E2E
	              2D2E2E2E
	              212E2E2E
	              2D2E2E2E
	              2B2E2E2E
	              2D2E2E2E
	              212E2E2E
	              2D2E2E2E
	              2B2E2E2E
	              2D2E2E2E
	              212E2E2E
	              2D2E2E2E
	              2B2E2E2E
	              2D2E2E2E
  44:     -	8344  212E2E2E		ascii   '!...-...+...-...!...-...+...-...!...-...+...-...!...-...+...-...'
	              2D2E2E2E
	              2B2E2E2E
	              2D2E2E2E
	              212E2E2E
	              2D2E2E2E
	              2B2E2E2E
	              2D2E2E2E
	              212E2E2E
	              2D2E2E2E
	              2B2E2E2E
	              2D2E2E2E
	              212E2E2E
	              2D2E2E2E
	              2B2E2E2E
	              2D2E2E2E
  45:     -	8384  212E2E2E		ascii   '!...-...+...-...!...-...+...-...!...-...+...-...!...-...+...-...'
	              2D2E2E2E
	              2B2E2E2E
	              2D2E2E2E
	              212E2E2E
	              2D2E2E2E
	              2B2E2E2E
	              2D2E2E2E
	              212E2E2E
	              2D2E2E2E
	              2B2E2E2E
	              2D2E2E2E
	              212E2E2E
	              2D2E2E2E
	              2B2E2E2E
	              2D2E2E2E
  46:     -	83C4  212E2E2E		ascii   '!...-...+...-...!...-...+...-...!...-...+...-...!...-...+...-...'
	              2D2E2E2E
	              2B2E2E2E
	              2D2E2E2E
	              212E2E2E
	              2D2E2E2E
	              2B2E2E2E
	              2D2E2E2E
	              212E2E2E
	              2D2E2E2E
	              2B2E2E2E
	              2D2E2E2E
	              212E2E2E
	              2D2E2E2E
	              2B2E2E2E
	              2D2E2E2E
  47:				
  48:     -	8404  2A2A2A2A	helpt:	ascii   '************************** HELP PAGE ***************************'
	              2A2A2A2A
	              2A2A2A2A
	              2A2A2A2A
	              2A2A2A2A
	              2A2A2A2A
	              2A2A2048
	              454C5020
	              50414745
	              202A2A2A
	              2A2A2A2A
	              2A2A2A2A
	              2A2A2A2A
	              2A2A2A2A
	              2A2A2A2A
	              2A2A2A2A
  49:     -	8444  43555253		ascii   'CURSOR MOVEMENT, FINE            : A D W X, Z C                 '
	              4F52204D
	              4F56454D
	              454E542C
	              2046494E
	              45202020
	              20202020
	              20202020
	              203A2041
	              20442057
	              20582C20
	              5A204320
	              20202020
	              20202020
	              20202020
	              20202020
  50:     -	8484  4348414E		ascii   'CHANGE BAR COUNT, JUMP TO BAR POS: B, 1 2 3 4 5 6 7 8           '
	              47452042
	              41522043
	              4F554E54
	              2C204A55
	              4D502054
	              4F204241
	              5220504F
	              533A2042
	              2C203120
	              32203320
	              34203520
	              36203720
	              38202020
	              20202020
	              20202020
  51:     -	84C4  4E455854		ascii   'NEXT / PREV GRID POS             : ARROW-UP ARROW-DOWN          '
	              202F2050
	              52455620
	              47524944
	              20504F53
	              20202020
	              20202020
	              20202020
	              203A2041
	              52524F57
	              2D555020
	              4152524F
	              572D444F
	              574E2020
	              20202020
	              20202020
  52:     -	8504  4348414E		ascii   'CHANGE GRID STEP                 : G                            '
	              47452047
	              52494420
	              53544550
	              20202020
	              20202020
	              20202020
	              20202020
	              203A2047
	              20202020
	              20202020
	              20202020
	              20202020
	              20202020
	              20202020
	              20202020
  53:     -	8544  53455420		ascii   'SET GRID, SOUND, CLEAR           : SPACE, ENTER, CLEAR          '
	              47524944
	              2C20534F
	              554E442C
	              20434C45
	              41522020
	              20202020
	              20202020
	              203A2053
	              50414345
	              2C20454E
	              5445522C
	              20434C45
	              41522020
	              20202020
	              20202020
  54:     -	8584  504C4159		ascii   'PLAY & STOP                      : P                            '
	              20262053
	              544F5020
	              20202020
	              20202020
	              20202020
	              20202020
	              20202020
	              203A2050
	              20202020
	              20202020
	              20202020
	              20202020
	              20202020
	              20202020
	              20202020
  55:     -	85C4  414C4C20		ascii   'ALL NOTES OFF (MIDI PANIC)       : !                            '
	              4E4F5445
	              53204F46
	              4620284D
	              49444920
	              50414E49
	              43292020
	              20202020
	              203A2021
	              20202020
	              20202020
	              20202020
	              20202020
	              20202020
	              20202020
	              20202020
  56:     -	8604  544F4747		ascii   'TOGGLE TRACKING                  : T                            '
	              4C452054
	              5241434B
	              494E4720
	              20202020
	              20202020
	              20202020
	              20202020
	              203A2054
	              20202020
	              20202020
	              20202020
	              20202020
	              20202020
	              20202020
	              20202020
  57:     -	8644  4348414E		ascii   'CHANGE PLAYBACK SPEED            : N M , .                      '
	              47452050
	              4C415942
	              41434B20
	              53504545
	              44202020
	              20202020
	              20202020
	              203A204E
	              204D202C
	              202E2020
	              20202020
	              20202020
	              20202020
	              20202020
	              20202020
  58:     -	8684  4348414E		ascii   'CHANGE CUR TRACK MIDI CHANNEL    : + -                          '
	              47452043
	              55522054
	              5241434B
	              204D4944
	              49204348
	              414E4E45
	              4C202020
	              203A202B
	              202D2020
	              20202020
	              20202020
	              20202020
	              20202020
	              20202020
	              20202020
  59:     -	86C4  4348414E		ascii   'CHANGE CUR TRACK MIDI INSTRUMENT : U I                          '
	              47452043
	              55522054
	              5241434B
	              204D4944
	              4920494E
	              53545255
	              4D454E54
	              203A2055
	              20492020
	              20202020
	              20202020
	              20202020
	              20202020
	              20202020
	              20202020
  60:     -	8704  4348414E		ascii   'CHANGE CUR TRACK MIDI VELOCITY   : J K                          '
	              47452043
	              55522054
	              5241434B
	              204D4944
	              49205645
	              4C4F4349
	              54592020
	              203A204A
	              204B2020
	              20202020
	              20202020
	              20202020
	              20202020
	              20202020
	              20202020
  61:     -	8744  4348414E		ascii   'CHANGE CUR TRACK DRUM            : ARROW-LEFT ARROW-RIGHT       ' 
	              47452043
	              55522054
	              5241434B
	              20445255
	              4D202020
	              20202020
	              20202020
	              203A2041
	              52524F57
	              2D4C4546
	              54204152
	              524F572D
	              52494748
	              54202020
	              20202020
  62:     -	8784  4348414E		ascii   'CHANGE CUR TRACK GATE LENGTH     : *                            '
	              47452043
	              55522054
	              5241434B
	              20474154
	              45204C45
	              4E475448
	              20202020
	              203A202A
	              20202020
	              20202020
	              20202020
	              20202020
	              20202020
	              20202020
	              20202020
  63:     -	87C4  48454C50		ascii   'HELP, QUIT, LOAD & SAVE          : H, Q, L, S,                  '
	              2C205155
	              49542C20
	              4C4F4144
	              20262053
	              41564520
	              20202020
	              20202020
	              203A2048
	              2C20512C
	              204C2C20
	              532C2020
	              20202020
	              20202020
	              20202020
	              20202020
  64:     -	8804  4348414E		ascii   'CHANGE PATTERN                   : -                            '
	              47452050
	              41545445
	              524E2020
	              20202020
	              20202020
	              20202020
	              20202020
	              203A202D
	              20202020
	              20202020
	              20202020
	              20202020
	              20202020
	              20202020
	              20202020
  65:				
  66:				
  67:     -	8844  2E      	lastcur	     byte	'.'
  68:     -	8845  C03C    	lastcurpos   word 	$3c00+3*64 
  69:				
  70:     -	8847  00      	cursorx	byte 	0
  71:     -	8848  03      	cursory	byte 	3
  72:     -	8849  00      	blink   byte    0
  73:     -	884A  00      	status  byte    0
  74:     -	884B  00      	track	byte    0
  75:     -	884C  00      	delayc 	byte	0
  76:     -	884D  0A      	tempo   byte	10
  77:     -	884E  08      	numbars byte	8
  78:     -	884F  80      	numticks byte	8*16 
  79:     -	8850  04      	gridres byte  	4
  80:				
  81:     -	8851  00      	midicount     byte  0
  82:     -	8852  00      	curnote       byte  0
  83:     -	8853  00      	curvelocity   byte  0	
  84:     -	8854  00      	curchannel    byte  0	
  85:     -	8855  00      	curinstrument byte  0	
  86:					
  87:     -	8856  FC      	quantpat  byte  11111100b
  88:					
  89:     -	8857          	tracks1 	defs    6*64 		
  90:     -	89D7          	tracks2 	defs    6*64
  91:     -	8B57          	tracksoff1 	defs    6*64 		
  92:     -	8CD7          	tracksoff2 	defs    6*64
  93:				
  94:     -	8E57  24262833	drumnostracks		byte 36, 38, 40, 51, 44, 46 
	              2C2E
  95:     -	8E5D  00010203	channeltracks 		byte 0, 1, 2, 3, 4, 9
	              0409
  96:     -	8E63  01020304	instrumenttracks 	byte 1, 2, 3, 4, 5, 1 
	              0501
  97:     -	8E69  7F7F7F7F	velocitytracks	 	byte 127, 127, 127, 127, 127, 127
	              7F7F
  98:     -	8E6F  08080808	gatetracks	 	byte 8,8,8,8,8,8
	              0808
  99:				
 100:				;;  midi channel specific to support MIDI PANIC
 101:				;; curnoteschannels	byte 0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0 
 102:				;; curvelschannels		byte 0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
 103:				
 104:     -	8E75  00      	memcursorx byte 	0
 105:     -	8E76  00      	memcursory byte 	0
 106:					
 107:     -	8E77  00      	trackpos    byte        0
 108:     -	8E78  00      	qtrackpos   byte 	0
 109:				
 110:				
 111:				
 112:				keydown macro key
 113:					ld	a,(key >> 8)
 114:					and	key % $100
 115:					endm 
 116:				
 117:     -	0101          	k_@	equ	$380101
 118:     -	0102          	k_A	equ	$380102
 119:     -	0104          	k_B	equ	$380104
 120:     -	0108          	k_C	equ	$380108
 121:     -	0110          	k_D	equ	$380110
 122:     -	0120          	k_E	equ	$380120
 123:     -	0140          	k_F	equ	$380140
 124:     -	0180          	k_G	equ	$380180
 125:				
 126:     -	0201          	k_H	equ	$380201
 127:     -	0202          	k_I	equ	$380202
 128:     -	0204          	k_J	equ	$380204
 129:     -	0208          	k_K	equ	$380208
 130:     -	0210          	k_L	equ	$380210
 131:     -	0220          	k_M	equ	$380220
 132:     -	0240          	k_N	equ	$380240
 133:     -	0280          	k_O	equ	$380280
 134:				
 135:     -	0401          	k_P	equ	$380401
 136:     -	0402          	k_Q	equ	$380402
 137:     -	0404          	k_R	equ	$380404
 138:     -	0408          	k_S	equ	$380408
 139:     -	0410          	k_T	equ	$380410
 140:     -	0420          	k_U	equ	$380420
 141:     -	0440          	k_V	equ	$380440
 142:     -	0480          	k_W	equ	$380480
 143:				
 144:     -	0801          	k_X	equ	$380801
 145:     -	0802          	k_Y	equ	$380802
 146:     -	0804          	k_Z	equ	$380804
 147:				
 148:     -	1001          	k_0	equ	$381001
 149:     -	1002          	k_1	equ	$381002
 150:     -	1004          	k_2	equ	$381004
 151:     -	1008          	k_3	equ	$381008
 152:     -	1010          	k_4	equ	$381010
 153:     -	1020          	k_5	equ	$381020
 154:     -	1040          	k_6	equ	$381040
 155:     -	1080          	k_7	equ	$381080
 156:				
 157:     -	2001          	k_8	equ	$382001
 158:     -	2002          	k_9	equ	$382002
 159:     -	2004          	k_colon	equ	$382004
 160:     -	2008          	k_semi	equ	$382008
 161:     -	2010          	k_comma	equ	$382010
 162:     -	2020          	k_dash	equ	$382020
 163:     -	2040          	k_dot	equ	$382040
 164:     -	2080          	k_slash	equ	$382080
 165:				
 166:     -	4001          	k_enter	equ	$384001
 167:     -	4002          	k_clear	equ	$384002
 168:     -	4004          	k_break	equ	$384004
 169:     -	4008          	k_up	equ	$384008
 170:     -	4010          	k_down	equ	$384010
 171:     -	4020          	k_left	equ	$384020
 172:     -	4040          	k_right	equ	$384040
 173:     -	4080          	k_space	equ	$384080
 174:				
 175:     -	8001          	k_shift	equ	$388001
 176:				
 177:				
 178:     -	8E79          	main:
 179:				
 180:    0+11	8E79  DBFF    		in  a,($ff)
 181:   11+7	8E7B  F610    		or  a,$10 		; enable IO on Model III 
 182:					; and a,~$20 		; disable video wait states M III 
 183:   18+7	8E7D  E6BF    		and a,~$40 		; slode mode M4 
 184:   25+11	8E7F  D3EC    		out ($ec),a
 185:				
 186:   36+10	8E81  21C480  		ld	hl,data 
 187:   46+10	8E84  115788  		ld	de,tracks1
 188:   56+10	8E87  018001  		ld	bc,6*64 
 189:   66+16+5	8E8A  EDB0    		ldir
 190:				
 191:   82+10	8E8C  21C480  		ld	hl,data 
 192:   92+10	8E8F  11578B  		ld	de,tracksoff1
 193:  102+10	8E92  018001  		ld	bc,6*64 
 194:  112+16+5	8E95  EDB0    		ldir
 195:				
 196:  128+10	8E97  21C480  		ld	hl,data 
 197:  138+10	8E9A  11D789  		ld	de,tracks2 
 198:  148+10	8E9D  018001  		ld	bc,6*64 
 199:  158+16+5	8EA0  EDB0    		ldir
 200:				
 201:  174+10	8EA2  21C480  		ld	hl,data 
 202:  184+10	8EA5  11D78C  		ld	de,tracksoff2
 203:  194+10	8EA8  018001  		ld	bc,6*64 
 204:  204+16+5	8EAB  EDB0    		ldir
 205:				
 206:     -	8EAD          	main2:
 207:				
 208:  220+10	8EAD  21003C  		ld	hl,$3c00
 209:  230+10	8EB0  11013C  		ld	de,$3c00+1
 210:  240+10	8EB3  01FF03  		ld	bc,1024-1
 211:  250+10	8EB6  3620    		ld	(hl),' '
 212:  260+16+5	8EB8  EDB0    		ldir
 213:				
 214:  276+10	8EBA  210480  		ld	hl,title
 215:  286+10	8EBD  11003C  		ld	de,$3c00
 216:  296+10	8EC0  010004  		ld	bc,1024
 217:  306+16+5	8EC3  EDB0    		ldir
 218:				
 219:				
 220:  322+17	8EC5  CD5F96  		call screenupdate
 221:  339+17	8EC8  CD7696  		call showcursor
 222:  356+17	8ECB  CD3196  		call showplaycursor
 223:  373+17	8ECE  CDB396  		call showtempo
 224:				
 225:     -	8ED1          	loop:
 226:  390+13	8ED1  3A4A88  		ld a, (status) ; stopped ? 
 227:  403+4	8ED4  B7      		or a
 228:  407+10	8ED5  CA488F  		jp z, nostep
 229:					
 230:  417+13	8ED8  3A4C88  		ld a, (delayc)
 231:  430+4	8EDB  3C      		inc a
 232:  434+10	8EDC  214C88  		ld hl,delayc
 233:  444+7	8EDF  77      		ld (hl), a
 234:  451+4	8EE0  47      		ld b, a
 235:  455+13	8EE1  3A4D88  		ld a, (tempo) 
 236:  468+4	8EE4  B8      		cp b
 237:  472+10	8EE5  C2488F  		jp nz, nostep
 238:					
 239:					;;  inc note pointer
 240:  482+17	8EE8  CDE695  		call nextnote
 241:  499+17	8EEB  CD3196  		call showplaycursor
 242:  516+17	8EEE  CDA697  		call playnotes
 243:				
 244:  533+7	8EF1  3E00    		ld a,0
 245:  540+13	8EF3  324C88  		ld (delayc),a
 246:				
 247:  553+13	8EF6  3A4B88  		ld a,(track)
 248:  566+4	8EF9  B7      		or a
 249:  570+10	8EFA  CA488F  		jp z, nostep
 250:				
 251:					;; tracked - set screen cursor x to playcursor x
 252:				
 253:  580+13	8EFD  3A778E  		ld a,(trackpos)
 254:  593+8	8F00  CB77    		bit 6,a
 255:  601+7+5	8F02  201E    		jr nz,trackcury ; > 64 inc y
 256:				
 257:  608+8	8F04  CBB7    		res 6,a
 258:  616+13	8F06  324788  		ld (cursorx),a
 259:  629+13	8F09  32758E  		ld (memcursorx),a
 260:					
 261:  642+13	8F0C  3A4888  		ld a,(cursory)
 262:  655+7	8F0F  FE0A    		cp 10
 263:  662+7+5	8F11  382B    		jr c, showtrackcur
 264:				
 265:					
 266:  669+7	8F13  D607    		sub 7
 267:  676+13	8F15  324888  		ld (cursory), a
 268:  689+13	8F18  3A768E  		ld a,(memcursory)
 269:  702+7	8F1B  D606    		sub 6
 270:  709+13	8F1D  32768E  		ld (memcursory),a
 271:					
 272:  722+12	8F20  181C    		jr showtrackcur	
 273:				
 274:     -	8F22          	trackcury:
 275:  734+8	8F22  CBB7    		res 6,a	
 276:					
 277:  742+13	8F24  324788  		ld (cursorx),a
 278:  755+13	8F27  32758E  		ld (memcursorx),a
 279:				
 280:  768+13	8F2A  3A4888  		ld a,(cursory)
 281:  781+7	8F2D  FE0A    		cp 10
 282:  788+7+5	8F2F  300D    		jr nc,showtrackcur
 283:					
 284:  795+7	8F31  C607    		add 7	
 285:  802+13	8F33  324888  		ld (cursory),a
 286:  815+13	8F36  3A768E  		ld a,(memcursory)
 287:  828+7	8F39  C606    		add 6 
 288:  835+13	8F3B  32768E  		ld (memcursory),a
 289:					
 290:				
 291:     -	8F3E          	showtrackcur:
 292:  848+10	8F3E  214988  		ld hl, blink
 293:  858+10	8F41  367F    		ld (hl), 127
 294:				
 295:  868+17	8F43  CD7696  		call showcursor
 296:				
 297:  885+12	8F46  1816    		jr scan 
 298:					
 299:     -	8F48          	nostep:
 300:				
 301:  897+13	8F48  3A4988  		ld a,(blink)
 302:  910+4	8F4B  3C      		inc a
 303:  914+13	8F4C  324988  		ld (blink), a
 304:				
 305:  927+4	8F4F  B7      		or a
 306:  931+10	8F50  C2568F  		jp nz, cur1
 307:  941+17	8F53  CD7696  		call showcursor
 308:				
 309:     -	8F56          	cur1:	 
 310:  958+7	8F56  FE7F    		cp 127
 311:  965+10	8F58  C25E8F  		jp nz, scan  
 312:  975+17	8F5B  CD7696  		call showcursor
 313:						
 314:     -	8F5E          	scan:
 315:					
 316:  992+13	8F5E  3A4A88  		ld a, (status) 
 317: 1005+4	8F61  B7      		or a
 318: 1009+7+5	8F62  2021    		jr nz,scancont
 319:				
 320:					;; here we only sample if the tracking is stopped!
 321:				
 322: 1016+17	8F64  CDF790  		call midiin
 323: 1033+4	8F67  B7      		or a
 324: 1037+7+5	8F68  2803    		jr z, keyscan
 325:				
 326:					;; else, we got a note in the buffer: just treat this as setgridandsoundmidi for now
 327: 1044+10	8F6A  C37593  		jp setgridandsoundmidi
 328:				
 329:     -	8F6D          	keyscan:	 
 330:				
 331: 1054+17	8F6D  CD2B00  		call @KBD
 332: 1071+4	8F70  B7      		or a
 333: 1075+10	8F71  CAD18E  		jp z,loop
 334:				
 335: 1085+7	8F74  FE20    	        cp ' ' ; space
 336: 1092+10	8F76  CA6594  		jp z,setgridkey 
 337:				
 338: 1102+7	8F79  FE0D    		cp 13 ; enter
 339: 1109+10	8F7B  CAAB93  		jp z,setgridandsoundkey
 340:				
 341: 1119+7	8F7E  FE1F    		cp 31 ; clear 
 342: 1126+10	8F80  CAC194  		jp z,erasegrid
 343:				
 344: 1136+12	8F83  1810    		jr scancont1
 345:				
 346:     -	8F85          	scancont:
 347:				
 348: 1148+17	8F85  CDF790  		call midiin
 349: 1165+4	8F88  B7      		or a
 350: 1169+7+5	8F89  2803    		jr z, keyscan1 
 351:				
 352:					;; else, we got a note in the buffer: just treat this as setgridandsound for now
 353: 1176+10	8F8B  C37593  		jp setgridandsoundmidi
 354:				
 355:     -	8F8E          	keyscan1:	 
 356:				
 357: 1186+17	8F8E  CD2B00  		call @KBD
 358: 1203+4	8F91  B7      		or a
 359: 1207+10	8F92  CAD18E  		jp z,loop
 360:				
 361:     -	8F95          	scancont1:
 362:				
 363: 1217+7	8F95  FE5A    		cp 'Z' 
 364: 1224+10	8F97  CA4295  		jp z,left
 365: 1234+7	8F9A  FE59    		cp 'Y' 
 366: 1241+10	8F9C  CA4295  		jp z,left
 367: 1251+7	8F9F  FE41    		cp 'A' 
 368: 1258+10	8FA1  CA7291  		jp z,prevbar
 369: 1268+7	8FA4  FE43    		cp 'C'
 370: 1275+10	8FA6  CA5495  		jp z,right
 371: 1285+7	8FA9  FE44    		cp 'D'
 372: 1292+10	8FAB  CA5B91  		jp z,nextbar
 373: 1302+7	8FAE  FE57    		cp 'W'
 374: 1309+10	8FB0  CA6795  		jp z,up
 375: 1319+7	8FB3  FE58    		cp 'X' 
 376: 1326+10	8FB5  CA8495  		jp z,down
 377:				
 378: 1336+7	8FB8  FE2C    		cp ',' 
 379: 1343+10	8FBA  CA8F92  		jp z,faster	
 380: 1353+7	8FBD  FE2E    		cp '.'
 381: 1360+10	8FBF  CAC492  		jp z,slower 
 382: 1370+7	8FC2  FE4E    		cp 'N' 
 383: 1377+10	8FC4  CAA992  		jp z,faster1
 384: 1387+7	8FC7  FE4D    		cp 'M' 
 385: 1394+10	8FC9  CADE92  		jp z,slower1 
 386:						
 387: 1404+7	8FCC  FE50    		cp 'P' 
 388: 1411+10	8FCE  CAF194  		jp z,startstop
 389:				
 390: 1421+7	8FD1  FE54    		cp 'T'
 391: 1428+10	8FD3  CA1B95  		jp z,trackstatus
 392:					
 393: 1438+7	8FD6  FE08    		cp KCURLEFT
 394: 1445+10	8FD8  CA2193  		jp z,drumnodown
 395:				
 396: 1455+7	8FDB  FE09    		cp KCURRIGHT
 397: 1462+10	8FDD  CA1793  		jp z,drumnoup 
 398:				
 399: 1472+7	8FE0  FE2B    		cp '+'
 400: 1479+10	8FE2  CA2B93  		jp z,channelup
 401:				
 402: 1489+7	8FE5  FE2D    		cp '-'
 403: 1496+10	8FE7  CA3593  		jp z,channeldown
 404:				
 405: 1506+7	8FEA  FE55    		cp 'U'
 406: 1513+10	8FEC  CA5093  		jp z,instrumentdown
 407:				
 408: 1523+7	8FEF  FE49    		cp 'I'
 409: 1530+10	8FF1  CA3F93  		jp z,instrumentup
 410:				
 411: 1540+7	8FF4  FE4A    		cp 'J'
 412: 1547+10	8FF6  CA6B93  		jp z,velocitydown
 413:				
 414: 1557+7	8FF9  FE4B    		cp 'K'
 415: 1564+10	8FFB  CA6193  		jp z,velocityup
 416:				
 417: 1574+7	8FFE  FE5B    		cp KCURUP 
 418: 1581+10	9000  CA5B91  		jp z,nextbar
 419:				
 420: 1591+7	9003  FE0A    		cp KCURDOWN 
 421: 1598+10	9005  CA7291  		jp z,prevbar
 422:				
 423: 1608+7	9008  FE31    		cp '1'
 424: 1615+10	900A  CA8791  		jp z,bar1
 425:				
 426: 1625+7	900D  FE32    		cp '2'
 427: 1632+10	900F  CAA891  		jp z,bar2
 428:				
 429: 1642+7	9012  FE33    		cp '3'
 430: 1649+10	9014  CAC991  		jp z,bar3
 431:				
 432: 1659+7	9017  FE34    		cp '4'
 433: 1666+10	9019  CAEA91  		jp z,bar4
 434:				
 435: 1676+7	901C  FE35    		cp '5'
 436: 1683+10	901E  CA0B92  		jp z,bar5
 437:				
 438: 1693+7	9021  FE36    		cp '6'
 439: 1700+10	9023  CA2C92  		jp z,bar6
 440:				
 441: 1710+7	9026  FE37    		cp '7'
 442: 1717+10	9028  CA4D92  		jp z,bar7
 443:				
 444: 1727+7	902B  FE38    		cp '8'
 445: 1734+10	902D  CA6E92  		jp z,bar8
 446:				
 447: 1744+7	9030  FE51    		cp 'Q'
 448: 1751+10	9032  CA5891  		jp z,quit
 449:				
 450: 1761+7	9035  FE48    		cp 'H'
 451: 1768+10	9037  CA3491  		jp z,help
 452:				
 453: 1778+7	903A  FE4C    		cp 'L'
 454: 1785+10	903C  CA5291  		jp z,load
 455:				
 456: 1795+7	903F  FE53    		cp 'S'
 457: 1802+10	9041  CA5591  		jp z,save
 458:				
 459: 1812+7	9044  FE47    		cp 'G'
 460: 1819+10	9046  CA8890  		jp z,chgridres
 461:				
 462: 1829+7	9049  FE42    		cp 'B'
 463: 1836+10	904B  CADF90  		jp z,chgnumbars 
 464:				
 465: 1846+7	904E  FE21    		cp '!'
 466: 1853+10	9050  CAF992  		jp z,midipanic
 467:				
 468: 1863+7	9053  FE2A    		cp '*'
 469: 1870+10	9055  CA7990  		jp z,chggatelength
 470:				
 471:				
 472: 1880+10	9058  C3D18E  		jp loop 
 473:					
 474:					;;  do a screen update after keypress and continue 
 475:     -	905B          	cont:
 476: 1890+17	905B  CD5F96  		call screenupdate
 477: 1907+17	905E  CD5397  		call showtrack
 478: 1924+17	9061  CD1D97  		call showtrackdrum
 479: 1941+17	9064  CD2B97  		call showtrackchannel
 480: 1958+17	9067  CD3797  		call showtrackinstrument
 481: 1975+17	906A  CD4597  		call showtrackvelocity 
 482: 1992+17	906D  CDDB98  		call showgridres
 483: 2009+17	9070  CDF798  		call showbars
 484: 2026+17	9073  CDE998  		call showgate		
 485:					
 486: 2043+10	9076  C3D18E  		jp loop
 487:					
 488:     -	9079          	chggatelength:
 489: 2053+17	9079  CDF396  		call gettrackgate
 490: 2070+8	907C  CB27    		sla a 
 491: 2078+7	907E  E61F    		and $1f
 492: 2085+7+5	9080  2002    		jr nz,chggatelength1
 493: 2092+7	9082  3E01    		ld a,1
 494:					
 495:     -	9084          	chggatelength1:
 496: 2099+7	9084  77      		ld (hl), a
 497: 2106+10	9085  C35B90  		jp cont
 498:					
 499:     -	9088          	chgridres:
 500: 2116+13	9088  3A5088  		ld a,(gridres)
 501: 2129+8	908B  CB27    		sla a 
 502: 2137+7	908D  E61F    		and $1f
 503: 2144+7+5	908F  2002    		jr nz,chgridres1
 504: 2151+7	9091  3E01    		ld a,1
 505:					
 506:     -	9093          	chgridres1: 
 507: 2158+13	9093  325088  		ld (gridres),a
 508:					
 509: 2171+7	9096  FE01    		cp a,1
 510: 2178+7+5	9098  2008    		jr nz, gridres2
 511: 2185+7	909A  3EFF    		ld a,11111111b
 512: 2192+13	909C  325688  		ld (quantpat), a	
 513: 2205+10	909F  C35B90  		jp cont
 514:					
 515:     -	90A2          	gridres2:
 516: 2215+7	90A2  FE02    		cp a,2
 517: 2222+7+5	90A4  2008    		jr nz, gridres4
 518: 2229+7	90A6  3EFE    		ld a,11111110b
 519: 2236+13	90A8  325688  		ld (quantpat), a	
 520: 2249+10	90AB  C35B90  		jp cont
 521:				
 522:     -	90AE          	gridres4:
 523: 2259+7	90AE  FE04    		cp a,4
 524: 2266+7+5	90B0  2008    		jr nz, gridres8
 525: 2273+7	90B2  3EFC    		ld a,11111100b
 526: 2280+13	90B4  325688  		ld (quantpat), a	
 527: 2293+10	90B7  C35B90  		jp cont
 528:				
 529:     -	90BA          	gridres8:
 530: 2303+7	90BA  FE08    		cp a,8
 531: 2310+7+5	90BC  2008    		jr nz, gridres16
 532: 2317+7	90BE  3EF8    		ld a,11111000b
 533: 2324+13	90C0  325688  		ld (quantpat), a	
 534: 2337+10	90C3  C35B90  		jp cont
 535:				
 536:     -	90C6          	gridres16:
 537: 2347+7	90C6  FE10    		cp a,16
 538: 2354+7+5	90C8  2008    		jr nz, gridres32
 539: 2361+7	90CA  3EF0    		ld a,11110000b
 540: 2368+13	90CC  325688  		ld (quantpat), a	
 541: 2381+10	90CF  C35B90  		jp cont
 542:				
 543:     -	90D2          	gridres32:
 544: 2391+7	90D2  FE20    		cp a,32
 545: 2398+10	90D4  C25B90  		jp nz, cont 
 546: 2408+7	90D7  3EE0    		ld a,11100000b
 547: 2415+13	90D9  325688  		ld (quantpat), a	
 548: 2428+10	90DC  C35B90  		jp cont
 549:				
 550:				
 551:     -	90DF          	chgnumbars:
 552: 2438+13	90DF  3A4E88  		ld a,(numbars)
 553: 2451+4	90E2  3D      		dec a 
 554: 2455+4	90E3  3C      		inc a
 555: 2459+7	90E4  E607    		and $07
 556: 2466+4	90E6  3C      		inc a	
 557: 2470+13	90E7  324E88  		ld (numbars),a
 558:				
 559: 2483+4	90EA  47      		ld b,a
 560: 2487+7	90EB  3E00    		ld a,0
 561:     -	90ED          	countticks:	
 562: 2494+7	90ED  C610    		add 16 
 563: 2501+8+5	90EF  10FC    		djnz countticks
 564:				
 565: 2509+13	90F1  324F88  		ld (numticks),a
 566: 2522+10	90F4  C35B90  		jp cont
 567:				
 568:     -	90F7          	midiin:
 569:				
 570: 2532+11	90F7  DB09    		in a,(9)
 571: 2543+4	90F9  B7      		or a
 572: 2547+5+6	90FA  C8      		ret z
 573:				
 574:					;;  byte available
 575:				
 576: 2552+11	90FB  DB08    		in a,(8)
 577: 2563+8	90FD  CB7F    		bit 7,a
 578: 2571+7+5	90FF  201D    		jr nz, midicommand
 579:					
 580: 2578+4	9101  47      		ld b, a 
 581:					;; MIDI data byte
 582: 2582+13	9102  3A5188  		ld a, (midicount)
 583: 2595+4	9105  B7      		or a 
 584: 2599+5+6	9106  C8      		ret z
 585:				
 586:					;; note byte?
 587: 2604+7	9107  FE01    		cp 1
 588: 2611+7+5	9109  200C    		jr nz, velcheck
 589:				
 590: 2618+4	910B  78      		ld a, b 
 591: 2622+13	910C  325288  		ld (curnote), a
 592: 2635+7	910F  3E02    		ld a, 2 
 593: 2642+13	9111  325188  		ld (midicount), a
 594:				
 595: 2655+7	9114  3E00    		ld a, 0 
 596:				
 597: 2662+10	9116  C9      		ret
 598:				
 599:     -	9117          	velcheck:
 600: 2672+4	9117  78      		ld a, b
 601: 2676+13	9118  325388  		ld (curvelocity), a
 602:				
 603:					; signal message complete -> note / vel available
 604: 2689+7	911B  3E01    		ld a, 1
 605:				
 606: 2696+10	911D  C9      		ret 
 607:				
 608:     -	911E          	midicommand:	 
 609:				
 610: 2706+4	911E  47      		ld b, a 
 611: 2710+7	911F  3E00    		ld a, 0 
 612: 2717+13	9121  325188  		ld (midicount), a
 613:				
 614: 2730+4	9124  78      		ld a, b
 615:					;; note on? 
 616: 2734+7	9125  FE90    		cp $90 
 617: 2741+7+5	9127  2803    		jr z, midinoteon
 618:				
 619: 2748+7	9129  3E00    		ld a, 0
 620: 2755+10	912B  C9      		ret 
 621:				
 622:     -	912C          	midinoteon:	 
 623:				
 624:					;;  note on!
 625: 2765+7	912C  3E01    		ld a, 1
 626: 2772+13	912E  325188  		ld (midicount), a
 627:				
 628: 2785+7	9131  3E00    		ld a, 0
 629:					
 630: 2792+10	9133  C9      		ret	
 631:				
 632:				
 633:     -	9134          	help:
 634:				
 635: 2802+10	9134  21003C  		ld	hl,$3c00
 636: 2812+10	9137  11013C  		ld	de,$3c00+1
 637: 2822+10	913A  01FF03  		ld	bc,1024-1
 638: 2832+10	913D  3620    		ld	(hl),' '
 639: 2842+16+5	913F  EDB0    		ldir
 640:				
 641: 2858+10	9141  210484  		ld	hl,helpt
 642: 2868+10	9144  11003C  		ld	de,$3c00
 643: 2878+10	9147  010004  		ld	bc,1024 
 644: 2888+16+5	914A  EDB0    		ldir
 645:				
 646: 2904+17	914C  CD4900  		call @KEY
 647:					
 648: 2921+10	914F  C3AD8E  		jp main2
 649:				
 650:     -	9152          	load:
 651: 2931+10	9152  C3D18E  		jp loop 
 652:				
 653:     -	9155          	save:
 654: 2941+10	9155  C3D18E  		jp loop 
 655:					
 656:     -	9158          	quit:
 657: 2951+17	9158  CD2D40  		call @EXIT
 658:					
 659:     -	915B          	nextbar:
 660: 2968+13	915B  3A4788  		ld a,(cursorx)
 661: 2981+10	915E  215088  		ld hl,gridres
 662: 2991+7	9161  46      		ld b,(hl)
 663: 2998+4	9162  80      		add a,b
 664: 3002+7	9163  FE40    		cp 64
 665: 3009+10	9165  D25B90  		jp nc, cont
 666: 3019+13	9168  324788  		ld (cursorx),a
 667: 3032+10	916B  21758E  		ld hl,memcursorx 
 668: 3042+7	916E  77      		ld (hl),a
 669: 3049+10	916F  C35B90  		jp cont
 670:				
 671:     -	9172          	prevbar:
 672: 3059+13	9172  3A4788  		ld a,(cursorx)
 673: 3072+10	9175  215088  		ld hl,gridres
 674: 3082+7	9178  46      		ld b,(hl)
 675: 3089+4	9179  90      		sub a,b
 676: 3093+10	917A  DA5B90  		jp c, cont
 677: 3103+13	917D  324788  		ld (cursorx),a
 678: 3116+10	9180  21758E  		ld hl,memcursorx 
 679: 3126+7	9183  77      		ld (hl),a
 680: 3133+10	9184  C35B90  		jp cont
 681:				
 682:				setbar1x macro
 683:					ld (cursorx), a
 684:					ld hl,memcursorx 
 685:					ld (hl),a
 686:				
 687:					ld a, (cursory)
 688:					cp 9
 689:					jp c,cont
 690:					; else change y cursor 
 691:					sub 7 
 692:					ld (cursory),a
 693:					
 694:					ld a,(memcursory) 
 695:					sub 6
 696:					ld (memcursory),a
 697:				
 698:					jp cont
 699:					endm
 700:				
 701:				
 702:				setbar2x macro
 703:					ld (cursorx), a
 704:					ld hl,memcursorx 
 705:					ld (hl),a
 706:				
 707:					ld a, (cursory)
 708:					cp 10
 709:					jp nc,cont
 710:					; else change y cursor 
 711:					add 7 
 712:					ld (cursory),a
 713:					
 714:					ld a,(memcursory) 
 715:					add 6
 716:					ld (memcursory),a
 717:				
 718:					jp cont
 719:					endm 
 720:				
 721:     -	9187          	bar1:
 722: 3143+7	9187  3E00    		ld a,0
 723: 3150+123	9189  32478821		setbar1x 
	              758E773A
	              4888FE09
	              DA5B90D6
	              07324888
	              3A768ED6
	              0632768E
	              C35B90
 724:					
 725:     -	91A8          	bar2:	
 726: 3273+7	91A8  3E10    		ld a,16
 727: 3280+123	91AA  32478821		setbar1x 
	              758E773A
	              4888FE09
	              DA5B90D6
	              07324888
	              3A768ED6
	              0632768E
	              C35B90
 728:				
 729:     -	91C9          	bar3:
 730: 3403+7	91C9  3E20    		ld a,32
 731: 3410+123	91CB  32478821		setbar1x 
	              758E773A
	              4888FE09
	              DA5B90D6
	              07324888
	              3A768ED6
	              0632768E
	              C35B90
 732:				
 733:     -	91EA          	bar4:
 734: 3533+7	91EA  3E30    		ld a,48
 735: 3540+123	91EC  32478821		setbar1x 
	              758E773A
	              4888FE09
	              DA5B90D6
	              07324888
	              3A768ED6
	              0632768E
	              C35B90
 736:				
 737:     -	920B          	bar5:
 738: 3663+7	920B  3E00    		ld a,0
 739: 3670+123	920D  32478821		setbar2x 
	              758E773A
	              4888FE0A
	              D25B90C6
	              07324888
	              3A768EC6
	              0632768E
	              C35B90
 740:				
 741:     -	922C          	bar6:
 742: 3793+7	922C  3E10    		ld a,16
 743: 3800+123	922E  32478821		setbar2x
	              758E773A
	              4888FE0A
	              D25B90C6
	              07324888
	              3A768EC6
	              0632768E
	              C35B90
 744:					
 745:     -	924D          	bar7:
 746: 3923+7	924D  3E20    		ld a,32
 747: 3930+123	924F  32478821		setbar2x
	              758E773A
	              4888FE0A
	              D25B90C6
	              07324888
	              3A768EC6
	              0632768E
	              C35B90
 748:					
 749:     -	926E          	bar8:
 750: 4053+7	926E  3E30    		ld a,48
 751: 4060+123	9270  32478821		setbar2x 
	              758E773A
	              4888FE0A
	              D25B90C6
	              07324888
	              3A768EC6
	              0632768E
	              C35B90
 752:				
 753:     -	928F          	faster:
 754: 4183+13	928F  3A4D88  		ld a,(tempo)
 755: 4196+7	9292  FE01    		cp 1 
 756: 4203+10	9294  CA5B90  		jp z,cont
 757:					
 758: 4213+4	9297  3D      		dec a
 759: 4217+4	9298  4F      		ld c,a
 760: 4221+13	9299  324D88  		ld (tempo),a
 761: 4234+7	929C  3E00    		ld a,0
 762: 4241+10	929E  214C88  		ld hl,delayc
 763: 4251+10	92A1  3600    		ld (hl),0
 764: 4261+17	92A3  CDB396  		call showtempo
 765: 4278+10	92A6  C35B90  		jp cont
 766:				
 767:     -	92A9          	faster1:
 768: 4288+13	92A9  3A4D88  		ld a,(tempo)
 769: 4301+7	92AC  FE11    		cp $11
 770: 4308+10	92AE  DA5B90  		jp c,cont
 771:					
 772: 4318+7	92B1  D610    		sub $10
 773: 4325+4	92B3  4F      		ld c,a
 774: 4329+13	92B4  324D88  		ld (tempo),a
 775: 4342+7	92B7  3E00    		ld a,0
 776: 4349+10	92B9  214C88  		ld hl,delayc
 777: 4359+10	92BC  3600    		ld (hl),0
 778: 4369+17	92BE  CDB396  		call showtempo
 779: 4386+10	92C1  C35B90  		jp cont
 780:					
 781:     -	92C4          	slower:
 782: 4396+13	92C4  3A4D88  		ld a,(tempo)
 783: 4409+7	92C7  FEFF    		cp a,255
 784: 4416+10	92C9  CA5B90  		jp z,cont
 785:					
 786: 4426+4	92CC  3C      		inc a
 787: 4430+4	92CD  4F      		ld c,a
 788: 4434+13	92CE  324D88  		ld (tempo),a
 789: 4447+7	92D1  3E00    		ld a,0
 790: 4454+10	92D3  214C88  		ld hl,delayc
 791: 4464+10	92D6  3600    		ld (hl),0
 792:				
 793: 4474+17	92D8  CDB396  		call showtempo
 794: 4491+10	92DB  C35B90  		jp cont	
 795:				
 796:     -	92DE          	slower1:
 797: 4501+13	92DE  3A4D88  		ld a,(tempo)
 798: 4514+7	92E1  FEF0    		cp a,$f0
 799: 4521+10	92E3  D25B90  		jp nc,cont
 800:					
 801: 4531+7	92E6  C610    		add $10
 802: 4538+4	92E8  4F      		ld c,a
 803: 4542+13	92E9  324D88  		ld (tempo),a
 804: 4555+7	92EC  3E00    		ld a,0
 805: 4562+10	92EE  214C88  		ld hl,delayc
 806: 4572+10	92F1  3600    		ld (hl),0
 807:				
 808: 4582+17	92F3  CDB396  		call showtempo
 809: 4599+10	92F6  C35B90  		jp cont	
 810:				
 811:				testsoundx macro 
 812:					;; call gettrackdrum
 813:					;; ld b,a
 814:				
 815:					call gettrackchannel
 816:					ld (curchannel), a 
 817:					;; ld a,(curchannel)
 818:				
 819:					;;ld hl, curnoteschannels
 820:					;;ld d,0
 821:					;;ld e,a
 822:					;;add hl,de
 823:				
 824:					add $90 
 825:					out (8),a
 826:				  
 827:					call short_delay
 828:					ld a,(curnote)
 829:					out (8),a
 830:					;;ld (hl), a  		; store into CUR NOTES per CHANNEL for MIDI PANIC 
 831:				  
 832:					call short_delay
 833:					ld a,(curvelocity)
 834:					out (8),a
 835:				
 836:					;;ld b,a
 837:					;;ld hl, curvelschannels 
 838:					;;ld d,0
 839:					;;ld e,b
 840:					;;add hl,de 
 841:					;;ld a,(curchannel)
 842:					;;ld (hl), a  		; store into CUR VELOCITIES per CHANNEL for MIDI PANIC 
 843:				
 844:					endm 
 845:				
 846:     -	92F9          	midipanic:
 847:				
 848: 4609+7	92F9  0610    		ld b, $10 
 849:				
 850:     -	92FB          	channeloff:
 851:					;; ld a, b
 852:					;; dec a
 853:					;; add $80	
 854:					;; out (8),a  		; MIDI NOTE OFF for MIDI Channel in B 
 855:					;; call short_delay
 856:				
 857:					;; ld a, b
 858:					;; dec a
 859:					;; ld hl, curnoteschannels ; retrieve last MIDI ON Message for Channel in B NOTE 
 860:					;; ld d,0
 861:					;; ld e,a
 862:					;; add hl,de 
 863:					
 864:					;; ld a, (hl) 		; last MIDI NOTE ON Note
 865:					;; out (8), a
 866:					;; call short_delay
 867:				
 868:					;; ld a, b
 869:					;; dec a 
 870:					;; ld hl, curvelschannels ; retrieve last MIDI ON Message for Channel in B VELOCITY
 871:					;; ld d,0
 872:					;; ld e,a 
 873:					;; add hl,de 
 874:					
 875:					;; ld a, (hl) 		; last MIDI NOTE ON Velocity
 876:					;; out (8), a
 877:					;; call short_delay
 878:				
 879:				
 880: 4616+4	92FB  78      		ld a, b
 881: 4620+4	92FC  3D      		dec a
 882: 4624+7	92FD  C6B0    		add $b0	
 883: 4631+11	92FF  D308    		out (8),a  		; MIDI CC for Channel in a 
 884: 4642+17	9301  CD0399  		call short_delay
 885:				
 886: 4659+7	9304  3E7B    		ld a,123
 887: 4666+11	9306  D308    		out (8),a  		; MIDI NOTE OFF 
 888: 4677+17	9308  CD0399  		call short_delay
 889:				
 890: 4694+7	930B  3E00    		ld a,0
 891: 4701+11	930D  D308    		out (8),a  		; Don't Care 
 892: 4712+17	930F  CD0399  		call short_delay
 893:				
 894:					
 895:					;;  repeat for all 16 Channels 
 896: 4729+8+5	9312  10E7    		djnz channeloff
 897:					
 898: 4737+10	9314  C35B90  		jp cont
 899:					
 900:     -	9317          	drumnoup:
 901: 4747+17	9317  CDCC96  		call gettrackdrum
 902: 4764+4	931A  3C      		inc a 
 903: 4768+7	931B  E67F    		and $7f
 904: 4775+7	931D  77      		ld (hl), a
 905: 4782+10	931E  C35B90  		jp cont 
 906:				
 907:     -	9321          	drumnodown:
 908: 4792+17	9321  CDCC96  		call gettrackdrum
 909: 4809+4	9324  3D      		dec a 
 910: 4813+7	9325  E67F    		and $7f
 911: 4820+7	9327  77      		ld (hl), a
 912: 4827+10	9328  C35B90  		jp cont
 913:				
 914:     -	932B          	channelup:
 915: 4837+17	932B  CDD996  		call gettrackchannel 
 916: 4854+4	932E  3C      		inc a 
 917: 4858+7	932F  E60F    		and $0f
 918: 4865+7	9331  77      		ld (hl), a
 919: 4872+10	9332  C35B90  		jp cont 
 920:				
 921:     -	9335          	channeldown:
 922: 4882+17	9335  CDD996  		call gettrackchannel
 923: 4899+4	9338  3D      		dec a 
 924: 4903+7	9339  E60F    		and $0f 
 925: 4910+7	933B  77      		ld (hl), a
 926: 4917+10	933C  C35B90  		jp cont
 927:				
 928:     -	933F          	instrumentup:
 929: 4927+17	933F  CDE696  		call gettrackinstrument
 930: 4944+4	9342  3C      		inc a 
 931: 4948+7	9343  E67F    		and $7f
 932: 4955+7	9345  77      		ld (hl), a
 933:				
 934: 4962+17	9346  CDC196  		call gettracknr
 935: 4979+4	9349  3D      		dec a
 936: 4983+17	934A  CD5F97  		call setinstrument
 937:					
 938: 5000+10	934D  C35B90  		jp cont 
 939:				
 940:     -	9350          	instrumentdown:	
 941: 5010+17	9350  CDE696  		call gettrackinstrument
 942: 5027+4	9353  3D      		dec a 
 943: 5031+7	9354  E67F    		and $7f
 944: 5038+7	9356  77      		ld (hl), a
 945:				
 946: 5045+17	9357  CDC196  		call gettracknr
 947: 5062+4	935A  3D      		dec a
 948: 5066+17	935B  CD5F97  		call setinstrument
 949:					
 950: 5083+10	935E  C35B90  		jp cont
 951:				
 952:     -	9361          	velocityup:
 953: 5093+17	9361  CD0097  		call gettrackvelocity
 954: 5110+4	9364  3C      		inc a 
 955: 5114+7	9365  E67F    		and $7f
 956: 5121+7	9367  77      		ld (hl), a
 957: 5128+10	9368  C35B90  		jp cont 
 958:				
 959:     -	936B          	velocitydown:	
 960: 5138+17	936B  CD0097  		call gettrackvelocity
 961: 5155+4	936E  3D      		dec a 
 962: 5159+7	936F  E67F    		and $7f
 963: 5166+7	9371  77      		ld (hl), a
 964: 5173+10	9372  C35B90  		jp cont
 965:				
 966:				restorecellx macro 
 967:					ld a,(memcursorx)
 968:					
 969:					ld hl,data
 970:					ld d,0
 971:					ld e,a
 972:					add hl,de	
 973:					ld a,(hl)
 974:					endm 
 975:				
 976:				setgridx macro
 977:					call memcursor
 978:					; ld (hl),SETSYM
 979:					ld a, (curnote)
 980:					add DISPMIDINOTEOFFSET 
 981:				
 982:					ld (hl), a 
 983:					ld hl,lastcur
 984:					; ld (hl),SETSYM
 985:					ld (hl), a
 986:					endm 
 987:				
 988:				erasegridx macro
 989:					call memcursor
 990:					ld a, (hl)
 991:					;;  erase
 992:					push hl
 993:					restorecellx 
 994:					pop hl
 995:					ld (hl),a
 996:					ld hl,lastcur
 997:					ld (hl),a 
 998:					endm 
 999:				
1000:				gettrackdrumx macro 
1001:					call gettracknr
1002:					dec a
1003:					ld hl,drumnostracks
1004:					ld d,0
1005:					ld e,a
1006:					add hl, de 
1007:					ld a,(hl)
1008:					endm
1009:				
1010:				gettrackchannelx macro 
1011:					call gettracknr
1012:					dec a
1013:					ld hl,channeltracks
1014:					ld d,0
1015:					ld e,a
1016:					add hl, de 
1017:					ld a,(hl)
1018:					endm
1019:				
1020:				gettrackinstrumentx macro 
1021:					call gettracknr
1022:					dec a
1023:					ld hl,instrumenttracks
1024:					ld d,0
1025:					ld e,a
1026:					add hl, de 
1027:					ld a,(hl)
1028:					endm
1029:				
1030:				gettrackgatex macro 
1031:					call gettracknr
1032:					dec a
1033:					ld hl,gatetracks
1034:					ld d,0
1035:					ld e,a
1036:					add hl, de 
1037:					ld a,(hl)
1038:					endm
1039:				
1040:				gettrackvelocityx macro 
1041:					call gettracknr
1042:					dec a
1043:					ld hl,velocitytracks 
1044:					ld d,0
1045:					ld e,a
1046:					add hl, de 
1047:					ld a,(hl)
1048:					endm
1049:				
1050:     -	9375          	setgridandsoundmidi:
1051:				
1052:					;; we are taking MIDI channel and instrument
1053:					;; from the TRACK, and NOTE and VELOCITY from the MIDI message:
1054:					
1055: 5183+17	9375  CDD996  		call gettrackchannel
1056: 5200+13	9378  325488  		ld (curchannel), a  
1057:				
1058: 5213+17	937B  CDE696  		call gettrackinstrument
1059: 5230+13	937E  325588  		ld (curinstrument), a  
1060:				
1061: 5243+130	9381  CDD99632		testsoundx
	              5488C690
	              D308CD03
	              993A5288
	              D308CD03
	              993A5388
	              D308
1062: 5373+61	939B  CDC2953A		setgridx 
	              5288C661
	              77214488
	              77
1063:				
1064: 5434+10	93A8  C35B90  		jp cont 
1065:				
1066:     -	93AB          	setgridandsoundkey:
1067:				
1068: 5444+17	93AB  CDD996  		call gettrackchannel
1069: 5461+13	93AE  325488  		ld (curchannel), a  
1070:				
1071: 5474+17	93B1  CDCC96  		call gettrackdrum
1072: 5491+13	93B4  325288  		ld (curnote), a 
1073:				
1074: 5504+17	93B7  CD0097  		call gettrackvelocity
1075: 5521+13	93BA  325388  		ld (curvelocity), a  
1076:				
1077: 5534+17	93BD  CDE696  		call gettrackinstrument
1078: 5551+13	93C0  325588  		ld (curinstrument), a  
1079:					
1080: 5564+130	93C3  CDD99632		testsoundx
	              5488C690
	              D308CD03
	              993A5288
	              D308CD03
	              993A5388
	              D308
1081: 5694+61	93DD  CDC2953A		setgridx 
	              5288C661
	              77214488
	              77
1082:				
1083: 5755+10	93EA  C35B90  		jp cont 
1084:				
1085:     -	93ED          	setgridandsoundr:
1086:					
1087: 5765+130	93ED  CDD99632		testsoundx
	              5488C690
	              D308CD03
	              993A5288
	              D308CD03
	              993A5388
	              D308
1088: 5895+61	9407  CDC2953A		setgridx 
	              5288C661
	              77214488
	              77
1089:				
1090: 5956+10	9414  C9      		ret
1091:				
1092:     -	9415          	setgridandsoundkeyr:
1093:					
1094: 5966+17	9415  CDD996  		call gettrackchannel
1095: 5983+13	9418  325488  		ld (curchannel), a  
1096:				
1097: 5996+17	941B  CDCC96  		call gettrackdrum
1098: 6013+13	941E  325288  		ld (curnote), a 
1099:				
1100: 6026+17	9421  CD0097  		call gettrackvelocity
1101: 6043+13	9424  325388  		ld (curvelocity), a  
1102:					
1103: 6056+17	9427  CDE696  		call gettrackinstrument
1104: 6073+13	942A  325588  		ld (curinstrument), a  
1105:					
1106: 6086+130	942D  CDD99632		testsoundx
	              5488C690
	              D308CD03
	              993A5288
	              D308CD03
	              993A5388
	              D308
1107: 6216+61	9447  CDC2953A		setgridx 
	              5288C661
	              77214488
	              77
1108:				
1109: 6277+10	9454  C9      		ret
1110:				
1111:     -	9455          	setgrid:
1112:					
1113: 6287+61	9455  CDC2953A		setgridx 
	              5288C661
	              77214488
	              77
1114: 6348+10	9462  C35B90  		jp cont
1115:				
1116:     -	9465          	setgridkey:
1117:					
1118: 6358+17	9465  CDD996  		call gettrackchannel
1119: 6375+13	9468  325488  		ld (curchannel), a  
1120:				
1121: 6388+17	946B  CDCC96  		call gettrackdrum
1122: 6405+13	946E  325288  		ld (curnote), a 
1123:				
1124: 6418+17	9471  CD0097  		call gettrackvelocity
1125: 6435+13	9474  325388  		ld (curvelocity), a  
1126:					
1127: 6448+17	9477  CDE696  		call gettrackinstrument
1128: 6465+13	947A  325588  		ld (curinstrument), a  
1129:				
1130: 6478+61	947D  CDC2953A		setgridx 
	              5288C661
	              77214488
	              77
1131: 6539+10	948A  C35B90  		jp cont
1132:				
1133:     -	948D          	setgridr:
1134:				
1135: 6549+61	948D  CDC2953A		setgridx 
	              5288C661
	              77214488
	              77
1136: 6610+10	949A  C9      		ret
1137:				
1138:     -	949B          	setgridkeyr:
1139:				
1140: 6620+17	949B  CDD996  		call gettrackchannel
1141: 6637+13	949E  325488  		ld (curchannel), a  
1142:				
1143: 6650+17	94A1  CDCC96  		call gettrackdrum
1144: 6667+13	94A4  325288  		ld (curnote), a 
1145:				
1146: 6680+17	94A7  CD0097  		call gettrackvelocity
1147: 6697+13	94AA  325388  		ld (curvelocity), a  
1148:					
1149: 6710+17	94AD  CDE696  		call gettrackinstrument
1150: 6727+13	94B0  325588  		ld (curinstrument), a  
1151:					
1152: 6740+61	94B3  CDC2953A		setgridx 
	              5288C661
	              77214488
	              77
1153: 6801+10	94C0  C9      		ret
1154:				
1155:     -	94C1          	erasegrid:
1156:					
1157: 6811+121	94C1  CDC2957E		erasegridx 
	              E53A758E
	              21C48016
	              005F197E
	              E1772144
	              8877
1158: 6932+10	94D7  C35B90  		jp cont
1159:				
1160:     -	94DA          	erasegridr:
1161:					
1162: 6942+121	94DA  CDC2957E		erasegridx 
	              E53A758E
	              21C48016
	              005F197E
	              E1772144
	              8877
1163: 7063+10	94F0  C9      		ret 
1164:				
1165:     -	94F1          	startstop:
1166: 7073+13	94F1  3A4A88  		ld a,(status)
1167: 7086+7	94F4  EE01    		xor 1
1168: 7093+13	94F6  324A88  		ld (status), a
1169: 7106+4	94F9  B7      		or a
1170: 7110+7+5	94FA  200E    		jr nz, showplay
1171:					
1172: 7117+10	94FC  11463C  		ld de,$3c00 + 64 + 6
1173: 7127+10	94FF  210080  		ld hl,stopped 
1174: 7137+10	9502  010100  		ld bc,1 
1175: 7147+16+5	9505  EDB0    		ldir
1176: 7163+10	9507  C35B90  		jp cont
1177:					
1178:     -	950A          	showplay:
1179:				
1180: 7173+17	950A  CD8797  		call setmiditrackinstruments
1181:					
1182: 7190+10	950D  11463C  		ld de,$3c00 + 64 + 6
1183: 7200+10	9510  210180  		ld hl,playing  
1184: 7210+10	9513  010100  		ld bc,1
1185: 7220+16+5	9516  EDB0    		ldir
1186:				
1187:					
1188: 7236+10	9518  C35B90  		jp cont 
1189:				
1190:     -	951B          	trackstatus:
1191: 7246+13	951B  3A4B88  		ld a,(track)
1192: 7259+7	951E  EE01    		xor 1
1193: 7266+13	9520  324B88  		ld (track), a
1194: 7279+4	9523  B7      		or a
1195: 7283+7+5	9524  200E    		jr nz, showtrackstatus
1196:					
1197: 7290+10	9526  11473C  		ld de,$3c00 + 64 + 7
1198: 7300+10	9529  210280  		ld hl,free 
1199: 7310+10	952C  010100  		ld bc,1
1200: 7320+16+5	952F  EDB0    		ldir
1201: 7336+10	9531  C35B90  		jp cont
1202:					
1203:     -	9534          	showtrackstatus:	
1204: 7346+10	9534  11473C  		ld de,$3c00 + 64 + 7
1205: 7356+10	9537  210380  		ld hl,tracked   
1206: 7366+10	953A  010100  		ld bc,1
1207: 7376+16+5	953D  EDB0    		ldir
1208: 7392+10	953F  C35B90  		jp cont 
1209:				
1210:				
1211:     -	9542          	left:	
1212: 7402+13	9542  3A4788  		ld a,(cursorx)
1213: 7415+4	9545  B7      		or a
1214: 7419+10	9546  CA5B90  		jp z, cont
1215: 7429+4	9549  3D      		dec a	
1216: 7433+13	954A  324788  		ld (cursorx),a
1217: 7446+10	954D  21758E  		ld hl,memcursorx 
1218: 7456+7	9550  77      		ld (hl),a
1219: 7463+10	9551  C35B90  		jp cont
1220:     -	9554          	right:
1221: 7473+13	9554  3A4788  		ld a,(cursorx)
1222: 7486+7	9557  FE3F    		cp 63
1223: 7493+10	9559  CA5B90  		jp z, cont
1224: 7503+4	955C  3C      		inc a
1225: 7507+13	955D  324788  		ld (cursorx),a
1226: 7520+10	9560  21758E  		ld hl,memcursorx 
1227: 7530+7	9563  77      		ld (hl),a
1228: 7537+10	9564  C35B90  		jp cont
1229:     -	9567          	up:
1230: 7547+13	9567  3A4888  		ld a,(cursory)
1231: 7560+7	956A  FE03    		cp 3
1232: 7567+10	956C  CA5B90  		jp z, cont
1233: 7577+7	956F  FE0A    		cp 10
1234: 7584+7+5	9571  2004    		jr nz,up1
1235: 7591+7	9573  3E08    		ld a,8
1236: 7598+12	9575  1801    		jr up2
1237:     -	9577          	up1:	 
1238: 7610+4	9577  3D      		dec a
1239:				
1240:     -	9578          	up2:	
1241: 7614+13	9578  324888  		ld (cursory),a
1242:				
1243: 7627+10	957B  21768E  		ld hl,memcursory
1244: 7637+7	957E  7E      		ld a,(hl)
1245: 7644+4	957F  3D      		dec a
1246: 7648+7	9580  77      		ld (hl),a
1247:				
1248:					;; call setinstrument
1249:					
1250: 7655+10	9581  C35B90  		jp cont
1251:				
1252:     -	9584          	down:
1253: 7665+13	9584  3A4888  		ld a,(cursory)
1254: 7678+7	9587  FE0F    		cp 15
1255: 7685+10	9589  CA5B90  		jp z, cont
1256: 7695+7	958C  FE08    		cp 8
1257: 7702+7+5	958E  2004    		jr nz,down1
1258: 7709+7	9590  3E0A    		ld a,10
1259: 7716+12	9592  1801    		jr down2
1260:     -	9594          	down1:	
1261: 7728+4	9594  3C      		inc a
1262:     -	9595          	down2:	 
1263: 7732+13	9595  324888  		ld (cursory),a
1264:					
1265: 7745+10	9598  21768E  		ld hl,memcursory 
1266: 7755+7	959B  7E      		ld a,(hl)
1267: 7762+4	959C  3C      		inc a
1268: 7766+7	959D  77      		ld (hl),a
1269:				
1270:					;; call setinstrument
1271:				
1272: 7773+10	959E  C35B90  		jp cont
1273:				
1274:					
1275:     -	95A1          	cursor:
1276: 7783+13	95A1  3A4988  		ld a,(blink)
1277: 7796+4	95A4  3C      		inc a
1278: 7800+13	95A5  324988  		ld (blink),a
1279: 7813+10	95A8  21003C  		ld hl,$3c00
1280: 7823+13	95AB  3A4788  		ld a,(cursorx)
1281: 7836+4	95AE  B7      		or a
1282: 7840+7+5	95AF  2804    		jr z, moveyup
1283: 7847+4	95B1  47      		ld b,a
1284:     -	95B2          	movex:	
1285: 7851+6	95B2  23      		inc hl 
1286: 7857+8+5	95B3  10FD    		djnz movex
1287:     -	95B5          	moveyup:	
1288: 7865+13	95B5  3A4888  		ld a,(cursory)
1289: 7878+4	95B8  B7      		or a
1290: 7882+5+6	95B9  C8      		ret z
1291: 7887+4	95BA  47      		ld b,a
1292: 7891+10	95BB  114000  		ld de,64
1293:     -	95BE          	movey:
1294: 7901+11	95BE  19      		add hl,de 
1295: 7912+8+5	95BF  10FD    		djnz movey
1296: 7920+10	95C1  C9      		ret 
1297:				
1298:     -	95C2          	memcursor:
1299: 7930+10	95C2  215788  		ld hl,tracks1
1300: 7940+13	95C5  3A758E  		ld a,(memcursorx)
1301: 7953+4	95C8  B7      		or a
1302: 7957+7+5	95C9  2804    		jr z, mmoveyup
1303: 7964+4	95CB  47      		ld b,a
1304:     -	95CC          	mmovex:	
1305: 7968+6	95CC  23      		inc hl 
1306: 7974+8+5	95CD  10FD    		djnz mmovex
1307:     -	95CF          	mmoveyup:	
1308: 7982+13	95CF  3A768E  		ld a,(memcursory)
1309: 7995+4	95D2  B7      		or a
1310: 7999+5+6	95D3  C8      		ret z
1311: 8004+4	95D4  47      		ld b,a
1312: 8008+10	95D5  114000  		ld de,64
1313:     -	95D8          	mmovey:
1314: 8018+11	95D8  19      		add hl,de 
1315: 8029+8+5	95D9  10FD    		djnz mmovey
1316: 8037+10	95DB  C9      		ret 
1317:				
1318:					
1319: 8047+10	95DC  010000  	dly.01:	ld	bc,d10000th
1320:     -	0000          		sett	0
1321:    0+6	95DF  0B      	dly:	dec	bc
1322:    6+4	95E0  78      		ld	a,b
1323:   10+4	95E1  B1      		or	c
1324:   14+10	95E2  C2DF95  		jp	nz,dly
1325:   24+10	95E5  C9      		ret
1326:				
1327:				
1328:     -	95E6          	nextnote:
1329:				
1330:   34+13	95E6  3A788E  		ld a,(qtrackpos)
1331:   47+4	95E9  3C      		inc a
1332:   51+4	95EA  47      		ld b,a
1333:					
1334:   55+13	95EB  3A4F88  		ld a,(numticks)
1335:   68+4	95EE  B8      		cp b
1336:   72+4	95EF  78      		ld a,b
1337:   76+7+5	95F0  2002    		jr nz,nextnote0
1338:				
1339:					; max tick number reached, set to 0
1340:   83+7	95F2  3E00    		ld a, 0
1341:				
1342:     -	95F4          	nextnote0:
1343:   90+13	95F4  32788E  		ld (qtrackpos),a
1344:				
1345:  103+4	95F7  47      		ld b, a
1346:  107+13	95F8  3A5688  		ld a, (quantpat)
1347:  120+4	95FB  A0      		and b
1348:  124+13	95FC  32778E  		ld (trackpos),a
1349:				
1350:  137+4	95FF  B8      		cp b
1351:  141+7+5	9600  2810    		jr z, nextnote1
1352:				
1353:					;; ENTER sample keyboard; this one makes noise,
1354:					;; ONLY sample when (qtrackpos) = (trackpos)
1355:				
1356:  148+17	9602  CDF790  		call midiin
1357:  165+7	9605  FE01    		cp 1 
1358:  172+10+7	9607  CCED93  		call z,setgridandsoundr
1359:				
1360:  182+20	960A  3A4038E6		keydown k_enter 
	              01
1361:  202+10+7	960F  C41594  		call nz,setgridandsoundkeyr
1362:				
1363:     -	9612          	nextnote1:
1364:				
1365:					;; sample keyboard
1366:				
1367:  212+20	9612  3A4038E6		keydown k_space 
	              80
1368:  232+10+7	9617  C49B94  		call nz,setgridkeyr
1369:				
1370:  242+20	961A  3A4038E6		keydown k_clear
	              02
1371:  262+10+7	961F  C4DA94  		call nz,erasegridr
1372:				
1373:  272+13	9622  3A778E  		ld a, (trackpos)
1374:				
1375:  285+8	9625  CB7F    		bit 7,a
1376:  293+5+6	9627  C8      		ret z
1377:					
1378:  298+7	9628  3E00    		ld a,0
1379:  305+13	962A  32788E  		ld (qtrackpos),a
1380:  318+13	962D  32778E  		ld (trackpos),a
1381:					
1382:  331+10	9630  C9      		ret
1383:				
1384:     -	9631          	showplaycursor:
1385:					
1386:  341+10	9631  218480  		ld	hl,title+2*64 
1387:  351+10	9634  11803C  		ld	de,$3c00+2*64 
1388:  361+10	9637  014000  		ld	bc,64 
1389:  371+16+5	963A  EDB0    		ldir
1390:				
1391:  387+10	963C  214482  		ld	hl,title+9*64 
1392:  397+10	963F  11403E  		ld	de,$3c00+9*64 
1393:  407+10	9642  014000  		ld	bc,64 
1394:  417+16+5	9645  EDB0    		ldir
1395:				
1396:  433+13	9647  3A788E  		ld a,(qtrackpos)
1397:					
1398:  446+10	964A  21803C  		ld hl,$3c00+2*64
1399:  456+4	964D  5F      		ld e,a
1400:  460+7	964E  1600    		ld d,0 
1401:  467+11	9650  19      		add hl,de
1402:				
1403:  478+8	9651  CB77    		bit 6,a
1404:  486+7+5	9653  2003    		jr nz,showcurtrack2
1405:					
1406:  493+10	9655  36AA    		ld (hl),POSMARKSYM
1407:  503+10	9657  C9      		ret
1408:     -	9658          	showcurtrack2:
1409:  513+10	9658  118001  		ld de,6*64
1410:  523+11	965B  19      		add hl,de
1411:  534+10	965C  36AA    		ld (hl),POSMARKSYM
1412:  544+10	965E  C9      		ret
1413:					
1414:					
1415:     -	0000          	d10000th	equ	1774080 / t($) / 10000
1416:				
1417:					  
1418:     -	965F          	screenupdate:
1419:					
1420:					;;  swap in track 1 
1421:  554+10	965F  215788  		ld	hl,tracks1	
1422:  564+10	9662  11C03C  		ld	de,$3c00+3*64 
1423:  574+10	9665  018001  		ld	bc,6*64
1424:  584+16+5	9668  EDB0    		ldir
1425:				
1426:					;;  swap in track 1 
1427:  600+10	966A  21D789  		ld	hl,tracks2 
1428:  610+10	966D  11803E  		ld	de,$3c00+10*64 
1429:  620+10	9670  018001  		ld	bc,6*64
1430:  630+16+5	9673  EDB0    		ldir
1431:				
1432:  646+10	9675  C9      		ret
1433:				
1434:     -	9676          	showcursor:
1435:				
1436:  656+16	9676  2A4588  		ld hl,(lastcurpos)
1437:  672+13	9679  3A4488  		ld a,(lastcur)
1438:  685+7	967C  77      		ld (hl),a
1439:  692+17	967D  CDA195  		call cursor
1440:  709+16	9680  224588  		ld (lastcurpos),hl
1441:  725+7	9683  7E      		ld a,(hl)
1442:  732+13	9684  324488  		ld (lastcur),a
1443:					
1444:  745+13	9687  3A4988  		ld a,(blink)
1445:  758+7	968A  FE7F    		cp a,127
1446:  765+7+5	968C  3803    		jr c,cur2
1447:  772+10	968E  3658    		ld (hl), CURSYM 
1448:  782+10	9690  C9      		ret 
1449:				
1450:     -	9691          	cur2:
1451:  792+11	9691  E5      		push hl
1452:  803+52	9692  3A758E21		restorecellx
	              C4801600
	              5F197E
1453:  855+10	969D  E1      		pop hl 
1454:  865+10	969E  C9      		ret
1455:					
1456:					
1457:     -	969F          	byte2ascii: 			; input c, output de ASCII 
1458:  875+4	969F  79      	   ld a, c
1459:  879+4	96A0  1F      	   rra
1460:  883+4	96A1  1F      	   rra
1461:  887+4	96A2  1F      	   rra
1462:  891+4	96A3  1F      	   rra
1463:  895+17	96A4  CDA996  	   call convnibble 
1464:  912+4	96A7  57      	   ld d, a	
1465:  916+4	96A8  79      	   ld  a,c
1466:     -	96A9          	convnibble:
1467:  920+7	96A9  E60F    	   and  $0F
1468:  927+7	96AB  C690    	   add  a,$90
1469:  934+4	96AD  27      	   daa
1470:  938+7	96AE  CE40    	   adc  a,$40
1471:  945+4	96B0  27      	   daa
1472:  949+4	96B1  5F      	   ld e, a	
1473:  953+10	96B2  C9      	   ret
1474:				
1475:     -	96B3          	showtempo:
1476:  963+13	96B3  3A4D88  		ld a,(tempo)
1477:  976+4	96B6  4F      		ld c,a 
1478:  980+10	96B7  21593C  		ld hl,$3c00+64+25
1479:  990+17	96BA  CD9F96  		call byte2ascii
1480: 1007+7	96BD  72      		ld (hl),d
1481: 1014+6	96BE  23      		inc hl
1482: 1020+7	96BF  73      		ld (hl),e
1483: 1027+10	96C0  C9      		ret
1484:				
1485:     -	96C1          	gettracknr:
1486: 1037+13	96C1  3A768E  		ld a,(memcursory)
1487: 1050+7	96C4  C601    		add 1
1488: 1057+7	96C6  FE07    		cp 7
1489: 1064+5+6	96C8  D8      		ret c
1490: 1069+7	96C9  D606    		sub 6
1491: 1076+10	96CB  C9      		ret
1492:				
1493:				
1494:				
1495:     -	96CC          	gettrackdrum:
1496: 1086+60	96CC  CDC1963D		gettrackdrumx
	              21578E16
	              005F197E
1497: 1146+10	96D8  C9      		ret
1498:				
1499:     -	96D9          	gettrackchannel:
1500: 1156+60	96D9  CDC1963D		gettrackchannelx
	              215D8E16
	              005F197E
1501: 1216+10	96E5  C9      		ret
1502:				
1503:     -	96E6          	gettrackinstrument:	
1504: 1226+60	96E6  CDC1963D		gettrackinstrumentx 
	              21638E16
	              005F197E
1505: 1286+10	96F2  C9      		ret
1506:				
1507:     -	96F3          	gettrackgate:	
1508: 1296+60	96F3  CDC1963D		gettrackgatex 
	              216F8E16
	              005F197E
1509: 1356+10	96FF  C9      		ret
1510:				
1511:     -	9700          	gettrackvelocity:	
1512: 1366+60	9700  CDC1963D		gettrackvelocityx
	              21698E16
	              005F197E
1513: 1426+10	970C  C9      		ret
1514:				
1515:     -	970D          	gettrackdrumreg: ; input: e register, starting at 0
1516: 1436+10	970D  21578E  		ld hl,drumnostracks
1517: 1446+7	9710  1600    		ld d,0
1518: 1453+11	9712  19      		add hl, de 
1519: 1464+7	9713  46      		ld b,(hl)
1520: 1471+10	9714  C9      		ret
1521:				
1522:     -	9715          	gettrackchannelreg: ; input: e register, starting at 0
1523: 1481+10	9715  215D8E  		ld hl,channeltracks
1524: 1491+7	9718  1600    		ld d,0
1525: 1498+11	971A  19      		add hl, de 
1526: 1509+7	971B  46      		ld b,(hl)
1527: 1516+10	971C  C9      		ret
1528:				
1529:     -	971D          	showtrackdrum:
1530: 1526+17	971D  CDCC96  		call gettrackdrum
1531: 1543+4	9720  4F      		ld c, a
1532: 1547+10	9721  21743C  		ld hl,$3c00+64+52
1533: 1557+17	9724  CD9F96  		call byte2ascii
1534: 1574+7	9727  72      		ld (hl),d
1535: 1581+6	9728  23      		inc hl
1536: 1587+7	9729  73      		ld (hl),e
1537: 1594+10	972A  C9      		ret
1538:				
1539:     -	972B          	showtrackchannel:
1540: 1604+17	972B  CDD996  		call gettrackchannel 
1541: 1621+4	972E  4F      		ld c, a
1542: 1625+10	972F  216B3C  		ld hl,$3c00+64+43
1543: 1635+17	9732  CDA996  		call convnibble 
1544: 1652+7	9735  73      		ld (hl),e
1545: 1659+10	9736  C9      		ret
1546:				
1547:     -	9737          	showtrackinstrument:
1548: 1669+17	9737  CDE696  		call gettrackinstrument
1549: 1686+4	973A  4F      		ld c, a
1550: 1690+10	973B  216F3C  		ld hl,$3c00+64+47
1551: 1700+17	973E  CD9F96  		call byte2ascii
1552: 1717+7	9741  72      		ld (hl),d
1553: 1724+6	9742  23      		inc hl
1554: 1730+7	9743  73      		ld (hl),e
1555: 1737+10	9744  C9      		ret
1556:				
1557:     -	9745          	showtrackvelocity:
1558: 1747+17	9745  CD0097  		call gettrackvelocity
1559: 1764+4	9748  4F      		ld c, a
1560: 1768+10	9749  21793C  		ld hl,$3c00+64+57
1561: 1778+17	974C  CD9F96  		call byte2ascii
1562: 1795+7	974F  72      		ld (hl),d
1563: 1802+6	9750  23      		inc hl
1564: 1808+7	9751  73      		ld (hl),e
1565: 1815+10	9752  C9      		ret
1566:				
1567:     -	9753          	showtrack:
1568: 1825+17	9753  CDC196  		call gettracknr 
1569: 1842+4	9756  4F      		ld c,a 
1570: 1846+10	9757  21513C  		ld hl,$3c00+64+17
1571: 1856+17	975A  CDA996  		call convnibble 
1572: 1873+7	975D  73      		ld (hl),e
1573: 1880+10	975E  C9      		ret
1574:				
1575:     -	975F          	setinstrument: 			; a has track number 
1576:				
1577: 1890+11	975F  F5      		push af 
1578: 1901+14	9760  DD215D8E		ld ix,channeltracks 	; retrieve MIDI channel for track a
1579: 1915+4	9764  4F      		ld c,a
1580: 1919+7	9765  0600    		ld b,0
1581: 1926+15	9767  DD09    		add ix,bc
1582: 1941+19	9769  DD7E00  		ld a,(ix) 		; MIDI channel for track a is now in a 
1583:					
1584: 1960+7	976C  06C0    		ld b,$c0		; add $c0 for change instrument for MIDI channel in a 
1585: 1967+4	976E  80      		add a, b
1586: 1971+11	976F  D308    		out (8),a  		; change instrument for channel in a 
1587: 1982+17	9771  CD0399  		call short_delay
1588:				
1589: 1999+10	9774  F1      		pop af 
1590: 2009+14	9775  DD21638E		ld ix,instrumenttracks	; retrieve instrument for track a 
1591: 2023+4	9779  4F      		ld c,a
1592: 2027+7	977A  0600    		ld b,0
1593: 2034+15	977C  DD09    		add ix,bc
1594: 2049+19	977E  DD7E00  		ld a,(ix) 		; MIDI instrument for track a is now in a 
1595:				
1596: 2068+11	9781  D308    		out (8),a		; change MIDI instrument to a 
1597: 2079+17	9783  CD0399  		call short_delay
1598:				 
1599: 2096+10	9786  C9      		ret
1600:				
1601:     -	9787          	setmiditrackinstruments:
1602:				
1603: 2106+7	9787  3E00    		ld a, 0
1604: 2113+17	9789  CD5F97  		call setinstrument 
1605:				
1606: 2130+7	978C  3E01    		ld a, 1
1607: 2137+17	978E  CD5F97  		call setinstrument 
1608:					
1609: 2154+7	9791  3E02    		ld a, 2
1610: 2161+17	9793  CD5F97  		call setinstrument 
1611:					
1612: 2178+7	9796  3E03    		ld a, 3
1613: 2185+17	9798  CD5F97  		call setinstrument 
1614:					
1615: 2202+7	979B  3E04    		ld a, 4
1616: 2209+17	979D  CD5F97  		call setinstrument 
1617:					
1618: 2226+7	97A0  3E05    		ld a, 5
1619: 2233+17	97A2  CD5F97  		call setinstrument 
1620:					
1621: 2250+10	97A5  C9      		ret
1622:					
1623:     -	97A6          	playnotes:
1624: 2260+13	97A6  3A788E  		ld a,(qtrackpos)
1625:					
1626: 2273+8	97A9  CB77    		bit 6,a
1627: 2281+7+5	97AB  2010    		jr nz,playhightracks ; > 64  
1628:				
1629: 2288+10	97AD  21578B  		ld hl,tracksoff1	
1630: 2298+17	97B0  CDCD97  		call stoptracks
1631:				
1632: 2315+13	97B3  3A788E  		ld a,(qtrackpos)
1633: 2328+10	97B6  215788  		ld hl,tracks1	
1634: 2338+17	97B9  CD2498  		call playtracks
1635:				
1636: 2355+10	97BC  C9      		ret
1637:					
1638:     -	97BD          	playhightracks:
1639:				
1640: 2365+10	97BD  21D78C  		ld hl,tracksoff2
1641: 2375+17	97C0  CDCD97  		call stoptracks
1642:				
1643: 2392+13	97C3  3A788E  		ld a,(qtrackpos)
1644: 2405+10	97C6  21D789  		ld hl,tracks2 
1645: 2415+17	97C9  CD2498  		call playtracks
1646:				
1647: 2432+10	97CC  C9      		ret
1648:				
1649:					
1650:     -	97CD          	stoptracks: 
1651:					; add track index
1652:					; clear bit 6
1653: 2442+8	97CD  CBB7    		res 6,a
1654: 2450+4	97CF  5F      		ld e,a
1655: 2454+7	97D0  1600    		ld d,0
1656: 2461+11	97D2  19      		add hl,de
1657: 2472+10	97D3  014000  		ld bc,64
1658:				
1659: 2482+11	97D6  E5      		push hl
1660: 2493+11	97D7  C5      		push bc
1661:					
1662: 2504+7	97D8  4E      		ld c,(hl) ; -> c is note off
1663: 2511+7	97D9  1600    		ld d,0
1664: 2518+7	97DB  1E00    		ld e,0 ; e is track number 
1665: 2525+17	97DD  CDB498  		call stopnote
1666:				
1667: 2542+10	97E0  C1      		pop bc
1668: 2552+10	97E1  E1      		pop hl
1669:					
1670: 2562+11	97E2  09      		add hl,bc
1671:				
1672: 2573+11	97E3  E5      		push hl
1673: 2584+11	97E4  C5      		push bc
1674:				
1675: 2595+7	97E5  4E      		ld c,(hl)
1676: 2602+7	97E6  1600    		ld d,0
1677: 2609+7	97E8  1E01    		ld e,1 
1678: 2616+17	97EA  CDB498  		call stopnote
1679:				
1680: 2633+10	97ED  C1      		pop bc
1681: 2643+10	97EE  E1      		pop hl
1682:				
1683: 2653+11	97EF  09      		add hl,bc
1684:				
1685: 2664+11	97F0  E5      		push hl
1686: 2675+11	97F1  C5      		push bc
1687:					
1688: 2686+7	97F2  4E      		ld c,(hl) 
1689: 2693+7	97F3  1600    		ld d,0
1690: 2700+7	97F5  1E02    		ld e,2
1691: 2707+17	97F7  CDB498  		call stopnote
1692:				
1693: 2724+10	97FA  C1      		pop bc
1694: 2734+10	97FB  E1      		pop hl
1695:				
1696: 2744+11	97FC  09      		add hl,bc
1697:				
1698: 2755+11	97FD  E5      		push hl
1699: 2766+11	97FE  C5      		push bc
1700:				
1701: 2777+7	97FF  4E      		ld c,(hl) 
1702: 2784+7	9800  1600    		ld d,0
1703: 2791+7	9802  1E03    		ld e,3 
1704: 2798+17	9804  CDB498  		call stopnote
1705:				
1706: 2815+10	9807  C1      		pop bc
1707: 2825+10	9808  E1      		pop hl
1708:				
1709: 2835+11	9809  09      		add hl,bc
1710:				
1711: 2846+11	980A  E5      		push hl
1712: 2857+11	980B  C5      		push bc
1713:				
1714: 2868+7	980C  4E      		ld c,(hl) 
1715: 2875+7	980D  1600    		ld d,0
1716: 2882+7	980F  1E04    		ld e,4 
1717: 2889+17	9811  CDB498  		call stopnote
1718:				
1719: 2906+10	9814  C1      		pop bc
1720: 2916+10	9815  E1      		pop hl
1721:					
1722: 2926+11	9816  09      		add hl,bc
1723:				
1724: 2937+11	9817  E5      		push hl
1725: 2948+11	9818  C5      		push bc
1726:				
1727: 2959+7	9819  4E      		ld c,(hl) 
1728: 2966+7	981A  1600    		ld d,0
1729: 2973+7	981C  1E05    		ld e,5 
1730: 2980+17	981E  CDB498  		call stopnote
1731:				
1732: 2997+10	9821  C1      		pop bc	
1733: 3007+10	9822  E1      		pop hl
1734:					
1735: 3017+10	9823  C9      		ret
1736:					
1737:     -	9824          	playtracks: 
1738:					; add track index
1739:					; clear bit 6
1740: 3027+8	9824  CBB7    		res 6,a
1741: 3035+4	9826  5F      		ld e,a
1742: 3039+7	9827  1600    		ld d,0
1743: 3046+11	9829  19      		add hl,de
1744: 3057+10	982A  014000  		ld bc,64
1745:				
1746: 3067+11	982D  E5      		push hl
1747: 3078+11	982E  C5      		push bc
1748:					
1749: 3089+7	982F  4E      		ld c,(hl) ; -> c is note on
1750: 3096+7	9830  1600    		ld d,0
1751: 3103+7	9832  1E00    		ld e,0 ; e is track number 
1752: 3110+17	9834  CD7B98  		call playnote
1753:				
1754: 3127+10	9837  C1      		pop bc
1755: 3137+10	9838  E1      		pop hl
1756:					
1757: 3147+11	9839  09      		add hl,bc
1758:				
1759: 3158+11	983A  E5      		push hl
1760: 3169+11	983B  C5      		push bc
1761:				
1762: 3180+7	983C  4E      		ld c,(hl)
1763: 3187+7	983D  1600    		ld d,0
1764: 3194+7	983F  1E01    		ld e,1 
1765: 3201+17	9841  CD7B98  		call playnote
1766:				
1767: 3218+10	9844  C1      		pop bc
1768: 3228+10	9845  E1      		pop hl
1769:				
1770: 3238+11	9846  09      		add hl,bc
1771:				
1772: 3249+11	9847  E5      		push hl
1773: 3260+11	9848  C5      		push bc
1774:					
1775: 3271+7	9849  4E      		ld c,(hl) 
1776: 3278+7	984A  1600    		ld d,0
1777: 3285+7	984C  1E02    		ld e,2
1778: 3292+17	984E  CD7B98  		call playnote
1779:				
1780: 3309+10	9851  C1      		pop bc
1781: 3319+10	9852  E1      		pop hl
1782:				
1783: 3329+11	9853  09      		add hl,bc
1784:				
1785: 3340+11	9854  E5      		push hl
1786: 3351+11	9855  C5      		push bc
1787:				
1788: 3362+7	9856  4E      		ld c,(hl) 
1789: 3369+7	9857  1600    		ld d,0
1790: 3376+7	9859  1E03    		ld e,3 
1791: 3383+17	985B  CD7B98  		call playnote
1792:				
1793: 3400+10	985E  C1      		pop bc
1794: 3410+10	985F  E1      		pop hl
1795:				
1796: 3420+11	9860  09      		add hl,bc
1797:				
1798: 3431+11	9861  E5      		push hl
1799: 3442+11	9862  C5      		push bc
1800:				
1801: 3453+7	9863  4E      		ld c,(hl) 
1802: 3460+7	9864  1600    		ld d,0
1803: 3467+7	9866  1E04    		ld e,4 
1804: 3474+17	9868  CD7B98  		call playnote
1805:				
1806: 3491+10	986B  C1      		pop bc
1807: 3501+10	986C  E1      		pop hl
1808:					
1809: 3511+11	986D  09      		add hl,bc
1810:				
1811: 3522+11	986E  E5      		push hl
1812: 3533+11	986F  C5      		push bc
1813:				
1814: 3544+7	9870  4E      		ld c,(hl) 
1815: 3551+7	9871  1600    		ld d,0
1816: 3558+7	9873  1E05    		ld e,5 
1817: 3565+17	9875  CD7B98  		call playnote
1818:				
1819: 3582+10	9878  C1      		pop bc	
1820: 3592+10	9879  E1      		pop hl
1821:					
1822: 3602+10	987A  C9      		ret
1823:					
1824:					
1825:     -	987B          	playnote: ; input note on in c; track number 0..5 in e 
1826:					
1827: 3612+4	987B  79      	        ld a, c 		; note on <> 0? no; return 
1828: 3616+7	987C  FE62    		cp DISPMIDINOTEOFFSET+1 
1829: 3623+5+6	987E  D8      		ret c
1830:				
1831: 3628+11	987F  C5      		push bc
1832: 3639+11	9880  E5      		push hl			; note pointer 
1833:					
1834: 3650+10	9881  215D8E  		ld hl,channeltracks 	; determine MIDI channel for track in e 
1835:					;; ld d,0
1836:					;; ld e,e 
1837: 3660+11	9884  19      		add hl, de 
1838: 3671+7	9885  7E      		ld a,(hl) 		; MIDI channel for track in e
1839:				
1840: 3678+7	9886  C690    		add $90			; MIDI NOTE ON for MIDI channel in a 
1841: 3685+11	9888  D308    		out (8),a
1842:				
1843: 3696+11	988A  D5      		push de
1844: 3707+17	988B  CD0399  		call short_delay
1845: 3724+10	988E  D1      		pop de
1846:				
1847: 3734+4	988F  79      		ld a,c			; c has the note number -> MIDI out 
1848: 3738+7	9890  D661    		sub DISPMIDINOTEOFFSET		
1849: 3745+11	9892  D308    		out (8),a
1850:					
1851: 3756+11	9894  D5      		push de
1852: 3767+17	9895  CD0399  		call short_delay
1853: 3784+10	9898  D1      		pop de
1854:					
1855: 3794+10	9899  216F8E  		ld hl,gatetracks
1856:					;; ld d,0
1857:					;; ld e,e		; track number
1858: 3804+11	989C  19      		add hl, de 
1859: 3815+7	989D  7E      		ld a,(hl)		; gate duration for track  
1860:				
1861: 3822+10	989E  E1      		pop hl 			; get note pointer + 12*64 + gate duration to ... 
1862: 3832+11	989F  D5      		push de
1863:					
1864: 3843+10	98A0  110003  		ld de, 12*64		; ... determine note off position in notes off grid 
1865: 3853+11	98A3  19      		add hl, de
1866: 3864+7	98A4  1600    		ld d, 0
1867: 3871+4	98A6  5F      		ld e, a
1868: 3875+11	98A7  19      		add hl, de
1869:				
1870: 3886+10	98A8  D1      		pop de
1871: 3896+10	98A9  C1      		pop bc 
1872:				
1873: 3906+4	98AA  79      		ld a, c			; get note number which was stored in c 
1874: 3910+7	98AB  77      		ld (hl), a 		; store note in note off grid
1875:				
1876: 3917+10	98AC  21698E  		ld hl,velocitytracks 	; determine MIDI velocity for track in e  
1877:					;; ld d,0
1878:					;; ld e,e 
1879: 3927+11	98AF  19      		add hl, de 
1880: 3938+7	98B0  7E      		ld a,(hl) 		; MIDI velocity for track in e 
1881: 3945+11	98B1  D308    		out (8),a
1882:					
1883: 3956+10	98B3  C9      		ret 
1884:				
1885:     -	98B4          	stopnote: ; input note off in c; track number 0..5 in e 
1886:				
1887: 3966+4	98B4  79      	        ld a, c 		; note on <> 0? no; return
1888: 3970+4	98B5  B7      		or a 
1889: 3974+5+6	98B6  C8      		ret z
1890:				
1891: 3979+10	98B7  3600    		ld (hl), 0 		; hl = note pointer; erase note for now, will be rescheduled when played again!	
1892:				
1893: 3989+11	98B9  C5      		push bc
1894:					
1895: 4000+10	98BA  215D8E  		ld hl,channeltracks 	; determine MIDI channel for track in e 
1896:					;; ld d,0
1897:					;; ld e,e 
1898: 4010+11	98BD  19      		add hl, de 
1899: 4021+7	98BE  7E      		ld a,(hl) 		; MIDI channel for track in e
1900:				
1901: 4028+7	98BF  C680    		add $80			; MIDI NOTE ON for MIDI channel in a 
1902: 4035+11	98C1  D308    		out (8),a
1903:				
1904: 4046+11	98C3  D5      		push de
1905: 4057+17	98C4  CD0399  		call short_delay
1906: 4074+10	98C7  D1      		pop de
1907:				
1908: 4084+4	98C8  79      		ld a,c			; c has the note number -> MIDI out 
1909: 4088+7	98C9  D661    		sub DISPMIDINOTEOFFSET		
1910: 4095+11	98CB  D308    		out (8),a
1911:				
1912: 4106+11	98CD  D5      		push de
1913: 4117+17	98CE  CD0399  		call short_delay
1914: 4134+10	98D1  D1      		pop de 
1915:					
1916: 4144+10	98D2  C1      		pop bc
1917:				
1918: 4154+10	98D3  21698E  		ld hl,velocitytracks 	; determine MIDI velocity for track in e  
1919:					;; ld d,0
1920:					;; ld e,e 
1921: 4164+11	98D6  19      		add hl, de 
1922: 4175+7	98D7  7E      		ld a,(hl) 		; MIDI velocity for track in e 
1923: 4182+11	98D8  D308    		out (8),a
1924:					
1925: 4193+10	98DA  C9      		ret 
1926:				
1927:     -	98DB          	showgridres:
1928: 4203+13	98DB  3A5088  		ld a,(gridres)
1929: 4216+4	98DE  4F      		ld c, a
1930: 4220+10	98DF  21643C  		ld hl,$3c00+64+36
1931: 4230+17	98E2  CD9F96  		call byte2ascii
1932: 4247+7	98E5  72      		ld (hl),d
1933: 4254+6	98E6  23      		inc hl
1934: 4260+7	98E7  73      		ld (hl),e
1935: 4267+10	98E8  C9      		ret
1936:				
1937:				
1938:     -	98E9          	showgate:
1939: 4277+17	98E9  CDF396  		call gettrackgate
1940: 4294+4	98EC  4F      		ld c, a
1941: 4298+10	98ED  217E3C  		ld hl,$3c00+64+62
1942: 4308+17	98F0  CD9F96  		call byte2ascii
1943: 4325+7	98F3  72      		ld (hl),d
1944: 4332+6	98F4  23      		inc hl
1945: 4338+7	98F5  73      		ld (hl),e
1946: 4345+10	98F6  C9      		ret
1947:					
1948:     -	98F7          	showbars:
1949: 4355+13	98F7  3A4E88  		ld a,(numbars)
1950: 4368+4	98FA  4F      		ld c, a
1951: 4372+10	98FB  21603C  		ld hl,$3c00+64+32
1952: 4382+17	98FE  CDA996  		call convnibble
1953: 4399+7	9901  73      		ld (hl),e
1954: 4406+10	9902  C9      		ret
1955:				
1956:				
1957:				
1958:     -	9903          	short_delay:
1959: 4416+10	9903  11FF00  	    ld de,$00ff
1960:     -	9906          	delloop: 
1961: 4426+6	9906  1B      	    dec de
1962: 4432+4	9907  7A      	    ld a,d
1963: 4436+4	9908  B3      	    or e
1964: 4440+10	9909  C20699  	    jp nz,delloop
1965: 4450+10	990C  C9      	    ret 
1966:				
1967:     -	8E79          		end main 



Statistics:

     4	passes
     0	jr promotions
   230	symbols
  4877	bytes

    33	macro calls
  1755	macro bytes
     0	invented symbols



Symbol Table:

@DSP           =33        51
@DSPLY         =4467      17511
@EXIT          =402D      16429
@KBD           =2B        43
@KEY           =49        73
CURSYM         =58        88
DISPMIDINOTEOFFSET=61        97
ENTER          =0D        13
KCURDOWN       =0A        10
KCURLEFT       =08        8
KCURRIGHT      =09        9
KCURUP         =5B        91
POSMARKSYM     =AA        170
SETSYM         =8F        143
bar1            9187      37255
bar2            91A8      37288
bar3            91C9      37321
bar4            91EA      37354
bar5            920B      37387
bar6            922C      37420
bar7            924D      37453
bar8            926E      37486
blink           8849      34889
byte2ascii      969F      38559
channeldown     9335      37685
channeloff      92FB      37627
channeltracks   8E5D      36445
channelup       932B      37675
chggatelength   9079      36985
chggatelength1  9084      36996
chgnumbars      90DF      37087
chgridres       9088      37000
chgridres1      9093      37011
cont            905B      36955
convnibble      96A9      38569
countticks      90ED      37101
cur1            8F56      36694
cur2            9691      38545
curchannel      8854      34900
curinstrument   8855      34901
curnote         8852      34898
cursor          95A1      38305
cursorx         8847      34887
cursory         8848      34888
curvelocity     8853      34899
d10000th       =00        0
data            80C4      32964
delayc          884C      34892
delloop         9906      39174
dly             95DF      38367
dly.01          95DC      38364
down            9584      38276
down1           9594      38292
down2           9595      38293
drumnodown      9321      37665
drumnostracks   8E57      36439
drumnoup        9317      37655
erasegrid       94C1      38081
erasegridr      94DA      38106
faster          928F      37519
faster1         92A9      37545
free            8002      32770
gatetracks      8E6F      36463
gettrackchannel 96D9      38617
gettrackchannelreg 9715      38677
gettrackdrum    96CC      38604
gettrackdrumreg 970D      38669
gettrackgate    96F3      38643
gettrackinstrument 96E6      38630
gettracknr      96C1      38593
gettrackvelocity 9700      38656
gridres         8850      34896
gridres16       90C6      37062
gridres2        90A2      37026
gridres32       90D2      37074
gridres4        90AE      37038
gridres8        90BA      37050
help            9134      37172
helpt           8404      33796
instrumentdown  9350      37712
instrumenttracks 8E63      36451
instrumentup    933F      37695
k_0            =00381001  3674113
k_1            =00381002  3674114
k_2            =00381004  3674116
k_3            =00381008  3674120
k_4            =00381010  3674128
k_5            =00381020  3674144
k_6            =00381040  3674176
k_7            =00381080  3674240
k_8            =00382001  3678209
k_9            =00382002  3678210
k_@            =00380101  3670273
k_A            =00380102  3670274
k_B            =00380104  3670276
k_C            =00380108  3670280
k_D            =00380110  3670288
k_E            =00380120  3670304
k_F            =00380140  3670336
k_G            =00380180  3670400
k_H            =00380201  3670529
k_I            =00380202  3670530
k_J            =00380204  3670532
k_K            =00380208  3670536
k_L            =00380210  3670544
k_M            =00380220  3670560
k_N            =00380240  3670592
k_O            =00380280  3670656
k_P            =00380401  3671041
k_Q            =00380402  3671042
k_R            =00380404  3671044
k_S            =00380408  3671048
k_T            =00380410  3671056
k_U            =00380420  3671072
k_V            =00380440  3671104
k_W            =00380480  3671168
k_X            =00380801  3672065
k_Y            =00380802  3672066
k_Z            =00380804  3672068
k_break        =00384004  3686404
k_clear        =00384002  3686402
k_colon        =00382004  3678212
k_comma        =00382010  3678224
k_dash         =00382020  3678240
k_dot          =00382040  3678272
k_down         =00384010  3686416
k_enter        =00384001  3686401
k_left         =00384020  3686432
k_right        =00384040  3686464
k_semi         =00382008  3678216
k_shift        =00388001  3702785
k_slash        =00382080  3678336
k_space        =00384080  3686528
k_up           =00384008  3686408
keyscan         8F6D      36717
keyscan1        8F8E      36750
lastcur         8844      34884
lastcurpos      8845      34885
left            9542      38210
load            9152      37202
loop            8ED1      36561
main            8E79      36473
main2           8EAD      36525
memcursor       95C2      38338
memcursorx      8E75      36469
memcursory      8E76      36470
midicommand     911E      37150
midicount       8851      34897
midiin          90F7      37111
midinoteon      912C      37164
midipanic       92F9      37625
mmovex          95CC      38348
mmovey          95D8      38360
mmoveyup        95CF      38351
movex           95B2      38322
movey           95BE      38334
moveyup         95B5      38325
nextbar         915B      37211
nextnote        95E6      38374
nextnote0       95F4      38388
nextnote1       9612      38418
nostep          8F48      36680
numbars         884E      34894
numticks        884F      34895
playhightracks  97BD      38845
playing         8001      32769
playnote        987B      39035
playnotes       97A6      38822
playtracks      9824      38948
prevbar         9172      37234
qtrackpos       8E78      36472
quantpat        8856      34902
quit            9158      37208
right           9554      38228
save            9155      37205
scan            8F5E      36702
scancont        8F85      36741
scancont1       8F95      36757
screenupdate    965F      38495
setgrid         9455      37973
setgridandsoundkey 93AB      37803
setgridandsoundkeyr 9415      37909
setgridandsoundmidi 9375      37749
setgridandsoundr 93ED      37869
setgridkey      9465      37989
setgridkeyr     949B      38043
setgridr        948D      38029
setinstrument   975F      38751
setmiditrackinstruments 9787      38791
short_delay     9903      39171
showbars        98F7      39159
showcursor      9676      38518
showcurtrack2   9658      38488
showgate        98E9      39145
showgridres     98DB      39131
showplay        950A      38154
showplaycursor  9631      38449
showtempo       96B3      38579
showtrack       9753      38739
showtrackchannel 972B      38699
showtrackcur    8F3E      36670
showtrackdrum   971D      38685
showtrackinstrument 9737      38711
showtrackstatus 9534      38196
showtrackvelocity 9745      38725
slower          92C4      37572
slower1         92DE      37598
startstop       94F1      38129
status          884A      34890
stopnote        98B4      39092
stopped         8000      32768
stoptracks      97CD      38861
tempo           884D      34893
title           8004      32772
track           884B      34891
trackcury       8F22      36642
tracked         8003      32771
trackpos        8E77      36471
tracks1         8857      34903
tracks2         89D7      35287
tracksoff1      8B57      35671
tracksoff2      8CD7      36055
trackstatus     951B      38171
up              9567      38247
up1             9577      38263
up2             9578      38264
velcheck        9117      37143
velocitydown    936B      37739
velocitytracks  8E69      36457
velocityup      9361      37729
